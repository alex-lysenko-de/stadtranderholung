<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - Stadtranderholung</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.21/vue.global.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        .container {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .card-header {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1.5rem;
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            padding: 0.75rem 1rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        .btn-info {
            background-color: #17a2b8; /* Bootstrap info color */
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-1px);
        }
        .btn-success {
            background-color: #28a745; /* Bootstrap success color */
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-1px);
        }
        .btn-outline-secondary {
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .alert {
            border-radius: 10px;
            border: none;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .card-body {
            padding: 2rem;
        }
        .qr-code {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            min-height: 270px; /* To prevent layout shift when QR is generated */
        }
        /* qrcode.js generates a canvas or table directly inside the target div */
        .qr-code canvas, .qr-code table {
            max-width: 100%;
            height: auto;
        }
        @media (max-width: 768px) {
            .container {
                padding-top: 1rem;
            }
            .card-body {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-10 col-lg-8">
                    <div class="card">
                        <div class="card-header text-center">
                            <h3 class="mb-0">
                                <i class="bi bi-gear-fill me-2"></i>
                                Configuration
                            </h3>
                            <p class="mb-0 mt-2">Verwalten Sie die Anwendungs-Einstellungen</p>
                        </div>
                        <div class="card-body">
                            <div v-if="showSuccess" class="alert alert-success d-flex align-items-center" role="alert">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                <div>
                                    {{ successMessage }}
                                </div>
                            </div>
                            
                            <div v-if="showError" class="alert alert-danger d-flex align-items-center" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <div>
                                    {{ errorMessage }}
                                </div>
                            </div>

                            <form @submit.prevent="saveToLocalStorage">
                                <div class="mb-3">
                                    <label for="year" class="form-label">Jahr:</label>
                                    <input type="text" id="year" class="form-control" v-model="formData.year" required>
                                </div>
                                <div class="mb-3">
                                    <label for="binCollection" class="form-label">Bin Collection Name (JSONBin.io):</label>
                                    <input type="text" id="binCollection" class="form-control" v-model="formData.bin_collection" placeholder="z.B. SR2025" required>
                                </div>
                                <div class="mb-3">
                                    <label for="binMasterKey" class="form-label">Master Key (JSONBin.io):</label>
                                    <input type="text" id="binMasterKey" class="form-control" v-model="formData.bin_master_key" required>
                                </div>
                                <div class="mb-3">
                                    <label for="binAccessKey" class="form-label">Access Key (JSONBin.io):</label>
                                    <input type="text" id="binAccessKey" class="form-control" v-model="formData.bin_access_key" required>
                                </div>
                                <div class="mb-3">
                                    <label for="baseUrl" class="form-label">Basis-URL (ohne Dateinamen):</label>
                                    <input type="text" id="baseUrl" class="form-control" v-model="formData.base_url" placeholder="z.B. https://raw.githack.com/alex-lysenko-de/stadtranderholung/main/" required>
                                </div>

                                <div class="d-grid gap-2 mb-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-2"></i>
                                        Einstellungen Speichern
                                    </button>
                                </div>
                            </form>

                            <div class="d-grid gap-2 mb-3">
                                <button @click="showAdminLoginUrl" class="btn btn-info">
                                    <i class="bi bi-person-gear me-2"></i>
                                    Admin Login URL anzeigen
                                </button>
                                <button @click="showBetreuerLoginUrl" class="btn btn-info">
                                    <i class="bi bi-person me-2"></i>
                                    Betreuer Login URL anzeigen
                                </button>
                            </div>

                            <div id="results" class="mt-4 p-3 border rounded bg-light" :class="{'d-none': !generatedUrl}">
                                <h5 class="mb-3">Generierte Login URL:</h5>
                                <div class="mb-3">
                                    <label class="form-label">URL:</label>
                                    <a :href="generatedUrl" target="_blank" class="d-block text-break">{{ generatedUrl }}</a>
                                </div>
                                <div class="d-grid gap-2 mb-3">
                                    <button @click="shareUrl" class="btn btn-success">
                                        <i class="bi bi-share me-2"></i>
                                        Verteilen (Whatsapp, E-Mail, Zwischenablage)
                                    </button>
                                    <button @click="copyToClipboard" class="btn btn-outline-secondary">
                                        <i class="bi bi-clipboard me-2"></i>
                                        In Zwischenablage kopieren
                                    </button>
                                </div>
                                <div class="qr-code text-center">
                                    
                                    <div id="qrcode" ref="qrcodeContainer"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    formData: {
                        year: new Date().getFullYear().toString(),
                        bin_collection: '',
                        bin_master_key: '',
                        bin_access_key: '',
                        base_url: 'https://raw.githack.com/alex-lysenko-de/stadtranderholung/main/'
                    },
                    generatedUrl: '',
                    qrCodeInstance: null, // To store the QRCode.js instance
                    showSuccess: false,
                    successMessage: '',
                    showError: false,
                    errorMessage: ''
                };
            },
            methods: {
                saveToLocalStorage() {
                    try {
                        for (const key in this.formData) {
                            localStorage.setItem(`config_${key}`, this.formData[key]);
                        }
                        this.showNotification('Einstellungen erfolgreich gespeichert!', 'success');
                    } catch (e) {
                        this.showNotification('Fehler beim Speichern der Einstellungen.', 'error');
                        console.error('Local storage save error:', e);
                    }
                },
                loadFromLocalStorage() {
                    for (const key in this.formData) {
                        const savedValue = localStorage.getItem(`config_${key}`);
                        if (savedValue !== null) {
                            this.formData[key] = savedValue;
                        }
                    }
                },
                generateUrl(is_admin) {
                    // Basic validation for essential fields
                    if (!this.formData.year || !this.formData.bin_collection || !this.formData.bin_master_key || !this.formData.bin_access_key || !this.formData.base_url) {
                        this.showNotification('Bitte füllen Sie alle erforderlichen Felder aus, um eine URL zu generieren.', 'error');
                        this.generatedUrl = '';
                        this.clearQrCode(); // Clear any existing QR code before returning
                        return;
                    }

                    const params = new URLSearchParams({
                        year: this.formData.year,
                        collection: this.formData.bin_collection,
                        masterkey: this.formData.bin_master_key,
                        bin_access_key: this.formData.bin_access_key
                    });
                    const page = is_admin ? "a_login.html" : "b_login.html";
                    const url = `${this.formData.base_url}${page}?${params.toString()}`;
                    this.generatedUrl = url;
                    
                    // Use $nextTick to ensure the DOM element for QR code is rendered
                    this.$nextTick(() => {
                        this.renderQrCode(this.generatedUrl);
                    });
                },
                renderQrCode(url) {
                    // Clear the container before generating a new QR code
                    // This is crucial to prevent multiple QR codes or errors if element is reused
                    const qrcodeDiv = this.$refs.qrcodeContainer;
                    if (qrcodeDiv) {
                        qrcodeDiv.innerHTML = ''; // Clear previous content (canvas/table)
                        
                        // If an instance exists, clear it. Otherwise, create a new one.
                        // We recreate the instance each time to ensure it works correctly
                        // especially after v-if transitions or manual clearing.
                        this.qrCodeInstance = new QRCode(qrcodeDiv, {
                            text: url,
                            width: 256,
                            height: 256,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                        // No need for makeCode(url) if text is provided in constructor.
                        // However, makeCode is useful if you want to change the QR code content later without recreating the instance.
                    }
                },
                clearQrCode() {
                    if (this.qrCodeInstance) {
                        this.qrCodeInstance.clear(); // Clear the QR code canvas/table
                        // It's often good practice to also nullify the instance if you're recreating it
                        this.qrCodeInstance = null;
                    }
                    // Also ensure the div is empty if the instance was not created
                    const qrcodeDiv = this.$refs.qrcodeContainer;
                    if (qrcodeDiv) {
                        qrcodeDiv.innerHTML = '';
                    }
                },
                showAdminLoginUrl() {
                    // Ensure the results block is shown
                    this.generatedUrl = ''; // Temporarily clear to ensure re-render and QR code clear
                    this.clearQrCode();
                    this.generateUrl(true);
                    if (this.generatedUrl) {
                        this.showNotification('Admin Login URL generiert.', 'success');
                    }
                },
                showBetreuerLoginUrl() {
                    // Ensure the results block is shown
                    this.generatedUrl = ''; // Temporarily clear to ensure re-render and QR code clear
                    this.clearQrCode();
                    this.generateUrl(false);
                    if (this.generatedUrl) {
                        this.showNotification('Betreuer Login URL generiert.', 'success');
                    }
                },
                shareUrl() {
                    if (navigator.share && this.generatedUrl) {
                        navigator.share({
                            title: 'Stadtranderholung Login',
                            text: 'Hier ist der Link zum Login für die Stadtranderholung App:',
                            url: this.generatedUrl,
                        }).catch((error) => {
                            console.error('Error sharing:', error);
                            this.showNotification('Fehler beim Teilen der URL. Bitte manuell kopieren.', 'error');
                        });
                    } else {
                        // Fallback for browsers that do not support navigator.share
                        this.copyToClipboard();
                        this.showNotification('Teilen nicht unterstützt. URL wurde in die Zwischenablage kopiert.', 'info');
                    }
                },
                copyToClipboard() {
                    if (this.generatedUrl) {
                        navigator.clipboard.writeText(this.generatedUrl)
                            .then(() => {
                                this.showNotification('URL in die Zwischenablage kopiert!', 'success');
                            })
                            .catch(err => {
                                console.error('Failed to copy: ', err);
                                this.showNotification('Fehler beim Kopieren in die Zwischenablage.', 'error');
                            });
                    }
                },
                showNotification(message, type) {
                    // Reset alerts
                    this.showSuccess = false;
                    this.showError = false;

                    if (type === 'success' || type === 'info') {
                        this.showSuccess = true;
                        this.successMessage = message;
                    } else if (type === 'error') {
                        this.showError = true;
                        this.errorMessage = message;
                    }
                    setTimeout(() => {
                        this.showSuccess = false;
                        this.showError = false;
                    }, 5000);
                }
            },
            mounted() {
                this.loadFromLocalStorage();
            }
        }).mount('#app');
    </script>
</body>
</html>