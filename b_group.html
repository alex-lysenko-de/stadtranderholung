<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruppe verwalten - Stadtranderholung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Allgemeine Stile für Hintergrund und Schriftarten */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 30px 0; /* Erhöhter oberer und unterer Abstand */
        }
        /* Stile für den Hauptcontainer, Zentrierung und maximale Breite */
        .main-container {
            max-width: 550px; /* Erhöhte maximale Breite */
            margin: 0 auto;
            padding: 30px; /* Erhöhter Innenabstand */
        }
        /* Stile für Gruppenkarten, Schatten und abgerundete Ecken */
        .group-card {
            background: white;
            border-radius: 20px; /* Erhöhter Eckenradius */
            box-shadow: 0 15px 40px rgba(0,0,0,0.25); /* Verstärkter Schatten */
            margin-bottom: 30px; /* Erhöhter Abstand zwischen den Karten */
            overflow: hidden; /* Für korrekte abgerundete Ecken */
        }
        /* Stile für den Kartenkopf */
        .card-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border-radius: 20px 20px 0 0; /* Entspricht dem border-radius der group-card */
            text-align: center;
            padding: 25px; /* Erhöhter Innenabstand des Kopfes */
            font-size: 1.5rem; /* Erhöhte Schriftgröße */
        }
        /* Stile für den Kartenkörper */
        .card-body {
            padding: 25px; /* Erhöhter Innenabstand des Kartenkörpers */
        }
        /* Allgemeine Stile für Schaltflächen */
        .btn-primary, .btn-secondary, .btn-outline-primary {
            border-radius: 12px; /* Erhöhter Eckenradius der Schaltflächen */
            padding: 14px 20px; /* Erhöhte Abstände der Schaltflächen */
            font-weight: bold;
            font-size: 1.1rem; /* Erhöhte Schriftgröße der Schaltflächen */
            transition: all 0.3s ease; /* Sanfter Übergang hinzugefügt */
        }
        /* Stile für die Hauptschaltfläche (Primary) */
        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
        }
        /* Stile für die sekundäre Schaltfläche (Secondary) */
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            border: none;
        }
        /* Stile für die Umriss-Schaltfläche (Outline) */
        .btn-outline-primary {
            border: 2px solid #4CAF50;
            color: #4CAF50;
            background-color: transparent;
        }
        .btn-outline-primary:hover {
            background-color: #4CAF50;
            color: white;
        }
        /* Stile für Eingabefelder */
        .form-control {
            border-radius: 12px; /* Erhöhter Eckenradius der Eingabefelder */
            border: 2px solid #dee2e6; /* Deutlichere Umrandung */
            padding: 15px; /* Erhöhter Innenabstand der Eingabefelder */
            font-size: 1.2rem; /* Erhöhte Schriftgröße der Eingabefelder */
            text-align: center;
        }
        .form-control:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.25);
        }
        /* Stile für große Eingabefelder und Schaltflächen in Eingabegruppen */
        .input-group-lg > .form-control,
        .input-group-lg > .btn {
            padding: 0.85rem 1.2rem; /* Anpassung für input-group-lg */
            font-size: 1.25rem;
            border-radius: 12px;
        }
        .input-group-lg .btn {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        /* Stile für den Ladespinner */
        .loading-spinner {
            display: inline-block; /* Sicherstellen, dass der Spinner bei Bedarf sichtbar ist */
            vertical-align: middle;
            margin-right: .5em;
        }
        /* Stile für die Betreuerliste */
        .betreuer-list {
            background: #f1f3f5; /* Etwas stärkerer Hintergrund */
            border-radius: 12px;
            padding: 20px; /* Erhöhter Abstand */
            margin-top: 20px; /* Erhöhter oberer Abstand */
        }
        /* Stile für ein einzelnes Betreuer-Element */
        .betreuer-item {
            background: white;
            border-radius: 10px; /* Erhöhter Eckenradius */
            padding: 10px 15px; /* Erhöhte Abstände */
            margin: 8px 0; /* Erhöhter Abstand zwischen den Elementen */
            border-left: 5px solid #4CAF50; /* Deutlicherer Streifen */
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); /* Leichter Schatten hinzugefügt */
            font-size: 1.1rem; /* Erhöhte Schriftgröße */
        }
        /* Stile für die Anzeige der Kinderanzahl */
        .count-display {
            font-size: 2.5rem; /* Deutlich erhöhte Schriftgröße */
            font-weight: bold;
            color: #4CAF50;
            text-align: center;
            margin: 15px 0; /* Erhöhter Abstand */
            cursor: pointer; /* Zeigt an, dass das Element anklickbar ist */
        }
        .count-null {
            color: #6c757d;
            font-style: italic;
            font-size: 1.5rem; /* Reduzierte Größe für "Nicht gesetzt" */
        }
        /* Stile für Eingabefeld-Labels */
        .form-label {
            font-weight: 600; /* Fettere Schrift für Labels */
            margin-bottom: 8px; /* Abstand unter dem Label */
            display: block; /* Damit das Label die gesamte Breite einnimmt */
            text-align: center; /* Textausrichtung zentriert */
            font-size: 1rem; /* Standard-Schriftgröße für das Label */
            color: #495057; /* Dunklere Textfarbe */
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="main-container">
            <div class="group-card">
                <div class="card-header">
                    <h2 class="mb-0">{{ groupTitle }}</h2>
                    <p class="mb-0 mt-2">{{ formattedCurrentDate }}</p>
                </div>
            </div>

            <div id="alertContainer"></div>

            <div class="group-card">
                <div class="card-body">
                    <h5 class="card-title text-center mb-4">Anzahl Kinder</h5>
                    <div class="mb-4">
                        <label for="kinderAnzahl" class="form-label">
                            Anzahl Kinder am Morgen (erhalten von Eltern)
                        </label>
                        <div v-if="bKinderAnzahl_EditMode" class="input-group input-group-lg">
                            <input type="number" class="form-control text-center" id="kinderAnzahl"
                                   min="0" max="20" placeholder="0" v-model.number="groupData.KinderAnzahl">
                            <button class="btn btn-primary" type="button" @click="saveKinderAnzahl" :disabled="isSavingKinderAnzahl || !isConfigLoaded">
                                <span v-if="isSavingKinderAnzahl" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                Speichern
                            </button>
                        </div>
                        <div v-else class="count-display" @click="bKinderAnzahl_EditMode = true">
                            <span class="count-null" v-if="groupData.KinderAnzahl === null">Nicht gesetzt</span>
                            <span v-else>{{ groupData.KinderAnzahl }}</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="kinderAnzahlNow" class="form-label">
                            Aktuelle Anzahl Kinder (nach Nachzählung)
                        </label>
                        <div v-if="bKinderAnzahlNow_EditMode" class="input-group input-group-lg">
                            <input type="number" class="form-control text-center" id="kinderAnzahlNow"
                                   min="0" max="20" placeholder="0" v-model.number="groupData.KinderAnzahlNow">
                            <button class="btn btn-primary" type="button" @click="saveKinderAnzahlNow" :disabled="isSavingKinderAnzahlNow || !isConfigLoaded">
                                <span v-if="isSavingKinderAnzahlNow" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                Aktualisieren
                            </button>
                        </div>
                        <div v-else class="count-display" @click="bKinderAnzahlNow_EditMode = true">
                            <span class="count-null" v-if="groupData.KinderAnzahlNow === null">Nicht gesetzt</span>
                            <span v-else>{{ groupData.KinderAnzahlNow }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="group-card">
                <div class="card-body">
                    <!--<h5 class="card-title text-center mb-4">Aktionen</h5>-->
                    <div class="d-grid gap-3">
                        <button class="btn btn-secondary d-none" @click="navigateToChildrenEdit" :disabled="!isConfigLoaded">
                            Liste der Kinder bearbeiten
                        </button>
                        <button class="btn btn-secondary d-none" @click="navigateToCalculation" :disabled="!isConfigLoaded">
                            Rechnen
                        </button>
                        <button class="btn btn-outline-primary mt-3" @click="goBack"> Zurück </button>
                    </div>
                </div>
            </div>
        </div>
        </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        /**
         * Standardkonfigurationswerte. Diese werden durch URL-Parameter oder LocalStorage überschrieben.
         */
        const CONFIG_DEFAULTS = {
            API_BASE_URL: 'https://api.jsonbin.io/v3/b',
            BIN_COLLECTION_NAME: 'SR2025',
            BIN_ID: '68834e6e7b4b8670d8a712d0', // Standard-BIN_ID gemäß Dokumentation
            MASTER_KEY: '$2a$10$Yxp3iL9EqLkbpNRwKv0et.hXwFYAtyN3wkFpYhkyiCmD8riOLllqm',
            ACCESS_KEY: '$2a$10$25EbEOOZQFXGw/T2PkMKm.EELC/3G9sFCI7TNaAxpkawvjEUhAYCu',
            TOTAL_GROUPS: 15,
            TOTAL_BUSES: 3
        };

        /**
         * Dienstprogrammklasse für die Verwaltung von JSONBin.io API-Interaktionen
         * Behandelt alle CRUD-Operationen mit ordnungsgemäßer Fehlerbehandlung
         */
        class JSONBinAPI {
            constructor(config) {
                this.config = config;
                // Header enthalten jetzt Access-Key für Schreiboperationen
                this.headers = {
                    'Content-Type': 'application/json',
                    'X-Master-Key': config.MASTER_KEY,
                    'X-Access-Key': config.ACCESS_KEY // Access-Key für PUT-Anfragen einbeziehen
                };
            }

            /**
             * Aktuelle Daten von JSONBin abrufen
             * @returns {Promise<Object>} Aktuelle Datenstruktur oder leeres Objekt
             */
            async getData() {
                try {
                    const response = await fetch(`${this.config.API_BASE_URL}/${this.config.BIN_ID}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': this.config.MASTER_KEY,
                            // Access-Key wird normalerweise für GET-Anfragen nicht benötigt, kann aber aus Konsistenzgründen sicher enthalten sein
                            'X-Access-Key': this.config.ACCESS_KEY
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP-Fehler! Status: ${response.status}`);
                    }

                    const result = await response.json();
                    return result.record || {}; // Sicherstellen, dass ein leeres Objekt zurückgegeben wird, wenn der Datensatz null/undefiniert ist
                } catch (error) {
                    console.error('Fehler beim Abrufen der Daten von JSONBin:', error);
                    return {}; // Leeres Objekt bei Fehler zurückgeben, um Anwendungsabstürze zu verhindern
                }
            }

            /**
             * Daten in JSONBin aktualisieren (PUT-Operation)
             * @param {Object} data - Vollständige Datenstruktur zum Speichern
             * @returns {Promise<boolean>} Erfolgsstatus
             */
            async updateData(data) {
                try {
                    const response = await fetch(`${this.config.API_BASE_URL}/${this.config.BIN_ID}`, {
                        method: 'PUT',
                        headers: this.headers, // Header mit Access-Key für PUT verwenden
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        // Versuch, die Fehlermeldung aus der Antwort zu lesen
                        const errorData = await response.json();
                        throw new Error(`HTTP-Fehler! Status: ${response.status}, Nachricht: ${errorData.message || 'Unbekannter Fehler'}`);
                    }

                    return true;
                } catch (error) {
                    console.error('Fehler beim Aktualisieren der Daten in JSONBin:', error);
                    return false;
                }
            }
        }

        /**
         * Dienstprogrammfunktionen für allgemeine Operationen
         */
        const Utils = {
            /**
             * Aktuelles Datum im Format YYYY-MM-DD abrufen
             * @returns {string} Formatiertes Datumszeichenfolge
             */
            getCurrentDate() {
                return new Date().toISOString().split('T')[0];
            },

            /**
             * URL-Parameter nach Namen abrufen
             * @param {string} name - Parametername
             * @returns {string|null} Parameterwert oder null
             */
            getURLParameter(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            },

            /**
             * Temporäre Nachricht für den Benutzer anzeigen
             * @param {string} message - Anzuzeigende Nachricht
             * @param {string} type - Bootstrap-Alert-Typ (success, danger, warning, info)
             */
            showAlert(message, type = 'info') {
                const alertContainer = document.getElementById('alertContainer');
                if (!alertContainer) return; // Sicherstellen, dass der Container existiert

                // Bestehende Warnungen löschen
                alertContainer.innerHTML = '';
                const alertHtml = `
                    <div class="alert alert-${type} alert-dismissible fade show mb-4" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                alertContainer.innerHTML = alertHtml;
                // Warnung nach 5 Sekunden automatisch ausblenden
                setTimeout(() => {
                    const alertElement = alertContainer.querySelector('.alert');
                    if (alertElement) {
                        const bsAlert = bootstrap.Alert.getInstance(alertElement) || new bootstrap.Alert(alertElement);
                        bsAlert.close();
                    }
                }, 5000);
            },

            /**
             * Konfigurationsparameter von URL oder LocalStorage laden.
             * URL-Parameter haben Vorrang. Fehlende Parameter verwenden Standardwerte.
             * Alle geladenen/Standardparameter werden im LocalStorage gespeichert.
             * @returns {Object} Ein Objekt, das die geladene Konfiguration oder eine Fehlermeldung enthält.
             */
            loadConfig: function() {
                const urlParams = new URLSearchParams(window.location.search);
                const config = {};
                const missingParams = [];

                // Alle erwarteten Parameter und deren LocalStorage-Schlüssel definieren
                const paramMap = {
                    'TOTAL_GROUPS': 'config_total_groups',
                    'TOTAL_BUSES': 'config_total_buses',
                    'MASTER_KEY': 'config_bin_master_key',
                    'ACCESS_KEY': 'config_bin_access_key',
                    'BIN_COLLECTION_NAME': 'config_bin_collection',
                    'BIN_ID': 'config_bin_id'
                };

                for (const urlParam in paramMap) {
                    const lsKey = paramMap[urlParam];
                    let value = urlParams.get(urlParam) || localStorage.getItem(lsKey);

                    if (value !== null && value !== '') {
                        // Spezielle Behandlung für numerische Parameter
                        if (urlParam === 'TOTAL_GROUPS' || urlParam === 'TOTAL_BUSES') {
                            config[urlParam] = parseInt(value, 10);
                        } else {
                            config[urlParam] = value;
                        }
                        // Im LocalStorage speichern, wenn es von der URL kam oder einfach sicherstellen, dass es dort ist
                        localStorage.setItem(lsKey, value);
                    } else {
                        // Prüfen, ob ein Standardwert in CONFIG_DEFAULTS existiert
                        if (CONFIG_DEFAULTS.hasOwnProperty(urlParam)) {
                            config[urlParam] = CONFIG_DEFAULTS[urlParam];
                            localStorage.setItem(lsKey, CONFIG_DEFAULTS[urlParam]); // Standardwert im LS speichern
                        } else {
                            missingParams.push(urlParam);
                        }
                    }
                }
                
                // API_BASE_URL ist eine Konstante und wird nicht über URL/LocalStorage übergeben
                config.API_BASE_URL = CONFIG_DEFAULTS.API_BASE_URL;

                if (missingParams.length > 0) {
                    return { config: null, error: `Es fehlen wesentliche Konfigurationsparameter: ${missingParams.join(', ')}. Bitte stellen Sie sicher, dass diese über die URL übergeben oder in index.html festgelegt werden.` };
                }
                
                return { config: config, error: null };
            }
        };

        /**
         * Hauptanwendung zur Gruppenverwaltung mit Vue.js 3
         * Verwaltet die Anzeige von Gruppendaten und die Verwaltung der Kinderanzahl
         */
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    groupNumber: null,
                    currentDate: '',
                    groupData: {
                        Betreuer: [],
                        KinderAnzahl: null,
                        KinderAnzahlNow: null
                    },
                    bKinderAnzahl_EditMode: true,
                    bKinderAnzahlNow_EditMode: true,
                    isSavingKinderAnzahl: false,
                    isSavingKinderAnzahlNow: false,
                    isLoadingBetreuer: true,
                    api: null, // API-Instanz wird nach dem Laden der Konfiguration initialisiert
                    groupTitle: 'Gruppe wird geladen...',
                    formattedCurrentDate: '',
                    isConfigLoaded: false, // Flag für den Konfigurationsladestatus
                    config: {} // Hier wird die geladene Konfiguration gespeichert
                };
            },

            mounted() {
                // Wird beim Mounten der Komponente (Seitenladung) aufgerufen
                this.initializeGroup();
            },

            methods: {
                /**
                 * Initialisiert die Gruppenseite: Ruft die Gruppennummer aus der URL ab,
                 * lädt KinderAnzahl aus dem localStorage und lädt Betreuer von JSONBin.
                 */
                async initializeGroup() {
                    // Konfiguration laden
                    const { config, error } = Utils.loadConfig();

                    if (error) {
                        Utils.showAlert(error, 'danger');
                        this.isConfigLoaded = false;
                        // Optional: Zurück zur Anmeldeseite, wenn Konfiguration fehlt
                        setTimeout(() => {
                            window.location.href = 'b_login.html';
                        }, 3000);
                        return;
                    }

                    this.config = config; // Geladene Konfiguration speichern
                    this.api = new JSONBinAPI(this.config); // API-Instanz mit geladener Konfiguration initialisieren
                    this.isConfigLoaded = true; // Konfiguration als geladen markieren

                    this.groupNumber = Utils.getURLParameter('gr');
                    this.currentDate = Utils.getCurrentDate();
                    this.formattedCurrentDate = this.formatDate(this.currentDate);

                    if (!this.groupNumber) {
                        Utils.showAlert('Gruppennummer nicht gefunden. Bitte über die Anmeldung zugreifen.', 'danger');
                        setTimeout(() => {
                            window.location.href = 'b_login.html';
                        }, 3000);
                        return;
                    }

                    this.groupTitle = `Gruppe ${this.groupNumber}`;

                    // KinderAnzahl aus localStorage laden
                    this.loadKinderAnzahlFromLocalStorage();

                    // Bearbeitungsmodus für KinderAnzahl festlegen: wenn Wert null ist, im Bearbeitungsmodus
                    this.bKinderAnzahl_EditMode = this.groupData.KinderAnzahl === null;
                    // Bearbeitungsmodus für KinderAnzahlNow festlegen: wenn Wert null ist, im Bearbeitungsmodus
                    this.bKinderAnzahlNow_EditMode = this.groupData.KinderAnzahlNow === null;


                    // Betreuerdaten von JSONBin laden (werden nicht angezeigt, sind aber zur Aufrechterhaltung der Datenstruktur erforderlich)
                    await this.loadBetreuerDataFromJSONBin();
                },

                /**
                 * Lädt den Wert von KinderAnzahl aus dem localStorage.
                 * Schlüssel im localStorage: `${currentDate}-${groupNumber}-KinderAnzahl`.
                 */
                loadKinderAnzahlFromLocalStorage() {
                    const storageKey = `${this.currentDate}-${this.groupNumber}-KinderAnzahl`;
                    const storedValue = localStorage.getItem(storageKey);
                    if (storedValue !== null) {
                        // Als Zahl parsen, falls ein Wert vorhanden ist
                        this.groupData.KinderAnzahl = parseInt(storedValue, 10);
                        if (isNaN(this.groupData.KinderAnzahl)) {
                            this.groupData.KinderAnzahl = null; // Wenn keine Zahl, zurücksetzen
                        }
                    } else {
                        this.groupData.KinderAnzahl = null; // Wenn nicht im localStorage, auf null setzen
                    }
                    console.log(`KinderAnzahl aus localStorage geladen (${storageKey}):`, this.groupData.KinderAnzahl);
                },

                /**
                 * Lädt Gruppendaten (hauptsächlich Betreuer) von JSONBin.io.
                 * KinderAnzahl und KinderAnzahlNow werden NICHT von JSONBin abgerufen.
                 */
                async loadBetreuerDataFromJSONBin() {
                    this.isLoadingBetreuer = true; // Ladespinner anzeigen
                    try {
                        const data = await this.api.getData();

                        // Prüfen, ob der Eintrag für das aktuelle Datum und die Gruppe existiert
                        if (data && data[this.currentDate] && data[this.currentDate].groups && data[this.currentDate].groups[this.groupNumber]) {
                            // Nur die Betreuerliste aus den JSONBin-Daten aktualisieren
                            // KinderAnzahl und KinderAnzahlNow werden beim Laden von JSONBin IGNORIERT.
                            // Sie werden über localStorage bzw. direkte Benutzereingabe verwaltet.
                            this.groupData.Betreuer = data[this.currentDate].groups[this.groupNumber].Betreuer || [];
                        } else {
                            // Wenn keine Daten für das aktuelle Datum/die Gruppe vorhanden sind, leere Betreuerliste initialisieren
                            this.groupData.Betreuer = [];

                            // Wenn dies der erste Ladevorgang für eine neue Gruppe/einen neuen Tag ist, leere Struktur in JSONBin speichern
                            console.log('Keine vorhandenen Daten für Gruppe/Tag in JSONBin. Struktur wird initialisiert.');
                            const updatedData = {
                                ...data, // Bestehende Daten/Daten beibehalten
                                [this.currentDate]: {
                                    ... (data[this.currentDate] || { groups: {}, buses: {} }), // Sicherstellen, dass das Objekt für das aktuelle Datum existiert und 'buses' enthält
                                    groups: {
                                        ... (data[this.currentDate] ? data[this.currentDate].groups : {}),
                                        // Gruppe initialisieren, aber KinderAnzahl und KinderAnzahlNow bleiben null (da sie nicht von JSONBin geladen werden)
                                        [this.groupNumber]: {
                                            Betreuer: [],
                                            KinderAnzahl: null,
                                            KinderAnzahlNow: null
                                        }
                                    }
                                }
                            };
                            // An den Server senden, ohne auf Antwort zu warten, um die Benutzeroberfläche nicht zu blockieren
                            this.api.updateData(updatedData).then(success => {
                                if (!success) console.error('Fehler beim Initialisieren der leeren Gruppendatenstruktur in JSONBin.');
                            });
                        }
                    } catch (error) {
                        console.error('Fehler beim Laden der Gruppendaten (Betreuer):', error);
                        Utils.showAlert('Fehler beim Laden der Betreuerdaten.', 'danger');
                    } finally {
                        this.isLoadingBetreuer = false; // Immer auf false setzen nach dem Versuch
                    }
                },

                /**
                 * Speichert KinderAnzahl (Morgenzählung) in JSONBin und localStorage.
                 */
                async saveKinderAnzahl() {
                    // Eingabe validieren
                    if (this.groupData.KinderAnzahl !== null && (isNaN(this.groupData.KinderAnzahl) || this.groupData.KinderAnzahl < 0 || this.groupData.KinderAnzahl > 20)) {
                        Utils.showAlert('Bitte geben Sie eine gültige Anzahl zwischen 0 und 20 ein.', 'warning');
                        return;
                    }

                    this.isSavingKinderAnzahl = true; // Speicherspinner anzeigen
                    try {
                        // KinderAnzahl-Feld in JSONBin aktualisieren
                        const success = await this.updateGroupFieldInJSONBin('KinderAnzahl', this.groupData.KinderAnzahl);

                        if (success) {
                            Utils.showAlert('Anzahl Kinder am Morgen gespeichert!', 'success');
                            // Zusätzlich im localStorage speichern
                            const storageKey = `${this.currentDate}-${this.groupNumber}-KinderAnzahl`;
                            localStorage.setItem(storageKey, this.groupData.KinderAnzahl);
                            console.log(`KinderAnzahl im localStorage gespeichert (${storageKey}):`, this.groupData.KinderAnzahl);

                            this.bKinderAnzahl_EditMode = false; // Nach erfolgreichem Speichern in den Anzeigemodus wechseln
                        } else {
                            Utils.showAlert('Fehler beim Speichern der Daten.', 'danger');
                        }
                    } catch (error) {
                        console.error('Fehler beim Speichern von KinderAnzahl:', error);
                        Utils.showAlert('Unerwarteter Fehler aufgetreten.', 'danger');
                    } finally {
                        this.isSavingKinderAnzahl = false; // Spinner ausblenden
                    }
                },

                /**
                 * Speichert KinderAnzahlNow (aktuelle Zählung) in JSONBin.
                 * KinderAnzahlNow wird nicht im localStorage gespeichert, da es immer manuell eingegeben wird.
                 */
                async saveKinderAnzahlNow() {
                    // Eingabe validieren
                    if (this.groupData.KinderAnzahlNow !== null && (isNaN(this.groupData.KinderAnzahlNow) || this.groupData.KinderAnzahlNow < 0 || this.groupData.KinderAnzahlNow > 20)) {
                        Utils.showAlert('Bitte geben Sie eine gültige Anzahl zwischen 0 und 20 ein.', 'warning');
                        return;
                    }

                    this.isSavingKinderAnzahlNow = true; // Speicherspinner anzeigen
                    try {
                        // KinderAnzahlNow-Feld in JSONBin aktualisieren
                        const success = await this.updateGroupFieldInJSONBin('KinderAnzahlNow', this.groupData.KinderAnzahlNow);

                        if (success) {
                            Utils.showAlert('Aktuelle Anzahl Kinder aktualisiert!', 'success');
                            // Nach erfolgreichem Speichern in den Anzeigemodus wechseln
                            this.bKinderAnzahlNow_EditMode = false;
                        } else {
                            Utils.showAlert('Fehler beim Speichern der Daten.', 'danger');
                        }
                    } catch (error) {
                        console.error('Fehler beim Speichern von KinderAnzahlNow:', error);
                        Utils.showAlert('Unerwarteter Fehler aufgetreten.', 'danger');
                    } finally {
                        this.isSavingKinderAnzahlNow = false; // Spinner ausblenden
                    }
                },

                /**
                 * Aktualisiert ein bestimmtes Feld in den Gruppendaten in JSONBin.
                 * Diese Funktion ruft den gesamten Bin ab, aktualisiert die Daten der spezifischen Gruppe für heute,
                 * und führt dann eine PUT-Anfrage aus, um den gesamten Bin zu aktualisieren.
                 * @param {string} field - Name des zu aktualisierenden Feldes (z.B. 'KinderAnzahl', 'KinderAnzahlNow')
                 * @param {any} value - Neuer Wert für das Feld
                 * @returns {Promise<boolean>} Erfolgsstatus
                 */
                async updateGroupFieldInJSONBin(field, value) {
                    try {
                        // 1. Gesamte aktuelle Datenstruktur von JSONBin.io abrufen
                        const currentData = await this.api.getData();

                        // 2. Sicherstellen, dass die erforderlichen verschachtelten Objekte für das aktuelle Datum und die Gruppe existieren
                        if (!currentData[this.currentDate]) {
                            currentData[this.currentDate] = { groups: {}, buses: {} }; // Sicherstellen, dass auch 'buses' initialisiert wird
                        }
                        if (!currentData[this.currentDate].groups) {
                            currentData[this.currentDate].groups = {};
                        }
                        if (!currentData[this.currentDate].groups[this.groupNumber]) {
                            // Wenn die Gruppe nicht existiert, mit Standardwerten initialisieren
                            currentData[this.currentDate].groups[this.groupNumber] = {
                                Betreuer: [],
                                KinderAnzahl: null,
                                KinderAnzahlNow: null
                            };
                        }

                        // 3. Das spezifische Feld für die aktuelle Gruppe und das Datum aktualisieren
                        currentData[this.currentDate].groups[this.groupNumber][field] = value;

                        // 4. Die aktualisierte Datenstruktur zurück an JSONBin.io senden
                        const success = await this.api.updateData(currentData);

                        if (success) {
                            // Bei Erfolg das lokale reaktive groupData-Objekt aktualisieren
                            // Dies stellt sicher, dass Änderungen sofort in der Benutzeroberfläche angezeigt werden
                            this.groupData[field] = value;
                            return true;
                        } else {
                            console.error(`Fehler beim Aktualisieren des Feldes ${field} in JSONBin.`);
                            return false;
                        }
                    } catch (error) {
                        console.error(`Fehler in updateGroupFieldInJSONBin für ${field}:`, error);
                        return false;
                    }
                },

                /**
                 * Navigiert zur Seite zur Bearbeitung von Kindern
                 */
                navigateToChildrenEdit() {
                    if (!this.isConfigLoaded) {
                        Utils.showAlert('App-Konfiguration konnte nicht geladen werden. Navigation nicht möglich.', 'danger');
                        return;
                    }
                    window.location.href = `group_edit.html?gr=${this.groupNumber}`;
                },

                /**
                 * Navigiert zur Berechnungsseite
                 */
                navigateToCalculation() {
                    if (!this.isConfigLoaded) {
                        Utils.showAlert('App-Konfiguration konnte nicht geladen werden. Navigation nicht möglich.', 'danger');
                        return;
                    }
                    window.location.href = `group_calc.html?gr=${this.groupNumber}`;
                },

                /**
                 * Zurück zur vorherigen Seite (Anmeldung oder Admin-Übersicht)
                 */
                goBack() {
                    window.history.back();
                },

                /**
                 * Datum für die Anzeige formatieren
                 * @param {string} dateString - Datum im Format YYYY-MM-DD
                 * @returns {string} Formatierte Datumszeichenfolge
                 */
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('de-DE', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
            }
        }).mount('#app');

        /**
         * Seiteninitialisierung nach dem Laden des DOM
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Font Awesome für Icons
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css';
            document.head.appendChild(link);

            console.log('Gruppenseite DOM geladen.');
        });
    </script>
</body>
</html>
