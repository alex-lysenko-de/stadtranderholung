<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruppe verwalten - Stadtranderholung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="app">
        <div class="main-container">
            <div class="group-card">
                <div id="alertContainer"></div>

                <div class="text-center mb-4">
                    <div class="icon">üë•</div>
                    <h3>Gruppe {{ groupNumber }}</h3>
                    <p>Betreuer: {{ betreuerName }}</p>
                    <p>Aktuelle Zeit: {{ currentDateTime }}</p>
                </div>

                <div v-if="loading" class="text-center my-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Daten werden geladen...</p>
                </div>

                <div v-else-if="!isConfigLoaded" class="text-center my-4 text-danger">
                    <p>Konfiguration konnte nicht geladen werden. Bitte versuchen Sie es erneut.</p>
                    <button class="btn btn-primary" @click="initializePage">Erneut versuchen</button>
                </div>

                <div v-else>
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" :style="{ width: progressWidth }" :aria-valuenow="activeChildrenCount" aria-valuemin="0" :aria-valuemax="totalChildrenCount">
                            {{ activeChildrenCount }} / {{ totalChildrenCount }} Kinder anwesend
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="newChildName" class="form-label">Neues Kind hinzuf√ºgen:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newChildName" v-model="newChildName" placeholder="Name des Kindes" @keyup.enter="addChild">
                            <button class="btn btn-add" @click="addChild" :disabled="!newChildName.trim()">Hinzuf√ºgen</button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th class="text-center">Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(child, index) in children" :key="index" :class="{ 'child-inactive': !child.active }">
                                    <td>{{ child.name }}</td>
                                    <td class="text-center">
                                        <button class="btn btn-toggle-status btn-sm me-1" @click="toggleChildStatus(index)">
                                            <i :class="child.active ? 'fas fa-toggle-on' : 'fas fa-toggle-off'"></i>
                                        </button>
                                        <button class="btn btn-remove btn-sm" @click="removeChild(index)">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr v-if="children.length === 0">
                                    <td colspan="2" class="text-center">Noch keine Kinder in dieser Gruppe.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-calc btn-action" @click="navigateToCalc">
                            üìä Ausflugs√ºbersicht
                        </button>
                        <button class="btn btn-back btn-action" @click="goBack">
                            ‚¨ÖÔ∏è Zur√ºck zur Anmeldung
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script type="module">
        import { CONFIG_DEFAULTS, JSONBinAPI, Utils } from './common.js';

        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    betreuerName: Utils.getStoredBetreuerName() || 'Unbekannt',
                    groupNumber: Utils.getStoredGroupNumber() || '', // Should be set during login
                    children: [],
                    newChildName: '',
                    loading: true, // Initially true while loading data
                    currentDateTime: '',
                    isConfigLoaded: false,
                    config: {}, // Loaded config from common.js
                    api: null,  // JSONBinAPI instance
                };
            },
            
            computed: {
                totalChildrenCount() {
                    return this.children.length;
                },
                activeChildrenCount() {
                    return this.children.filter(child => child.active).length;
                },
                progressWidth() {
                    if (this.totalChildrenCount === 0) return '0%';
                    return ((this.activeChildrenCount / this.totalChildrenCount) * 100).toFixed(0) + '%';
                }
            },
            
            mounted() {
                this.initializePage();
                this.startClock();
            },
            
            methods: {
                /**
                 * –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è Vue-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                 * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç API, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã
                 */
                async initializePage() {
                    this.loading = true; // Set loading state
                    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã b_group.html...');
                    const success = Utils.initializePage(this); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ common.js

                    if (success) {
                        console.log('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', this.config);
                        // Ensure groupNumber is available before fetching data
                        if (!this.groupNumber) {
                            Utils.showAlert('Gruppennummer nicht gefunden. Bitte loggen Sie sich erneut ein.', 'danger');
                            this.loading = false;
                            this.navigateTo('b_login.html'); // Redirect to login if group number is missing
                            return;
                        }
                        await this.fetchGroupData();
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.');
                        Utils.showAlert('Fehler beim Laden der Konfiguration. Die Seite kann nicht richtig funktionieren.', 'danger');
                        this.loading = false;
                    }
                    this.updateDateTime();
                },

                /**
                 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –∏–∑ JSONBin.io
                 */
                async fetchGroupData() {
                    if (!this.api) {
                        Utils.showAlert('API-Client nicht initialisiert.', 'danger');
                        this.loading = false;
                        return;
                    }
                    this.loading = true;
                    try {
                        const allData = await this.api.getData();
                        const groupData = allData.groups.find(g => g.groupNumber === parseInt(this.groupNumber));
                        
                        if (groupData) {
                            this.children = groupData.children || [];
                            Utils.showAlert('Gruppendaten erfolgreich geladen.', 'success');
                        } else {
                            this.children = [];
                            Utils.showAlert(`Gruppe ${this.groupNumber} nicht gefunden oder keine Kinderdaten vorhanden.`, 'warning');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø—ã:', error);
                        Utils.showAlert('Fehler beim Laden der Gruppendaten: ' + error.message, 'danger');
                    } finally {
                        this.loading = false;
                    }
                },

                /**
                 * –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–≥–æ —Ä–µ–±–µ–Ω–∫–∞ –≤ —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
                 */
                async addChild() {
                    const name = this.newChildName.trim();
                    if (!name) return;

                    this.loading = true;
                    try {
                        // Optimistic update
                        const newChild = { name: name, active: true };
                        this.children.push(newChild);
                        this.newChildName = ''; // Clear input field

                        // Update data on JSONBin
                        await this.updateGroupChildrenOnServer();
                        Utils.showAlert(`${name} wurde hinzugef√ºgt.`, 'success');
                    } catch (error) {
                        console.error('Fehler beim Hinzuf√ºgen des Kindes:', error);
                        Utils.showAlert('Fehler beim Hinzuf√ºgen des Kindes: ' + error.message, 'danger');
                        // Revert optimistic update if error
                        this.children = this.children.filter(child => child.name !== name || !child.active);
                    } finally {
                        this.loading = false;
                    }
                },

                /**
                 * –£–¥–∞–ª—è–µ—Ç —Ä–µ–±–µ–Ω–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
                 * @param {number} index - –ò–Ω–¥–µ–∫—Å —Ä–µ–±–µ–Ω–∫–∞ –≤ –º–∞—Å—Å–∏–≤–µ children.
                 */
                async removeChild(index) {
                    if (!confirm('Sind Sie sicher, dass Sie dieses Kind entfernen m√∂chten?')) return;

                    this.loading = true;
                    const removedChild = this.children[index];
                    try {
                        // Optimistic update
                        this.children.splice(index, 1);

                        // Update data on JSONBin
                        await this.updateGroupChildrenOnServer();
                        Utils.showAlert(`${removedChild.name} wurde entfernt.`, 'info');
                    } catch (error) {
                        console.error('Fehler beim Entfernen des Kindes:', error);
                        Utils.showAlert('Fehler beim Entfernen des Kindes: ' + error.message, 'danger');
                        // Revert optimistic update if error
                        this.children.splice(index, 0, removedChild);
                    } finally {
                        this.loading = false;
                    }
                },

                /**
                 * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ–±–µ–Ω–∫–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
                 * @param {number} index - –ò–Ω–¥–µ–∫—Å —Ä–µ–±–µ–Ω–∫–∞ –≤ –º–∞—Å—Å–∏–≤–µ children.
                 */
                async toggleChildStatus(index) {
                    this.loading = true;
                    const child = this.children[index];
                    const originalStatus = child.active;
                    try {
                        // Optimistic update
                        child.active = !child.active;

                        // Update data on JSONBin
                        await this.updateGroupChildrenOnServer();
                        Utils.showAlert(`${child.name} Status auf ${child.active ? 'anwesend' : 'abwesend'} ge√§ndert.`, 'success');
                    } catch (error) {
                        console.error('Fehler beim Umschalten des Status:', error);
                        Utils.showAlert('Fehler beim Umschalten des Status: ' + error.message, 'danger');
                        // Revert optimistic update if error
                        child.active = originalStatus;
                    } finally {
                        this.loading = false;
                    }
                },

                /**
                 * –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –¥–µ—Ç—è—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã –Ω–∞ JSONBin.io.
                 */
                async updateGroupChildrenOnServer() {
                    try {
                        let allData = await this.api.getData();
                        let groupIndex = allData.groups.findIndex(g => g.groupNumber === parseInt(this.groupNumber));

                        if (groupIndex !== -1) {
                            allData.groups[groupIndex].children = this.children;
                        } else {
                            // If group not found, add it with current children
                            allData.groups.push({
                                groupNumber: parseInt(this.groupNumber),
                                children: this.children
                            });
                        }
                        await this.api.updateData(allData);
                    } catch (error) {
                        console.error('Fehler beim Speichern der Gruppendaten:', error);
                        throw new Error('Speichern der Daten fehlgeschlagen: ' + error.message); // Propagate error
                    }
                },

                /**
                 * –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞, –ø–µ—Ä–µ–¥–∞–≤–∞—è –Ω–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã.
                 * –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç localStorage –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö.
                 */
                navigateToCalc() {
                    Utils.storeCurrentGroupNumber(this.groupNumber); // Save group number to localStorage
                    Utils.navigateTo('group_calc.html', this);
                },

                /**
                 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.
                 */
                goBack() {
                    Utils.navigateTo('b_login.html', this); // Go back to login
                },

                /**
                 * –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
                 */
                updateDateTime() {
                    this.currentDateTime = Utils.getCurrentDateTime();
                },

                /**
                 * –ó–∞–ø—É—Å–∫–∞–µ—Ç —á–∞—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
                 */
                startClock() {
                    this.updateDateTime();
                    setInterval(() => {
                        this.updateDateTime();
                    }, 60000);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>