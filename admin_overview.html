<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Übersicht</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        .inactive-group {
            color: #6c757d; /* Серый цвет для неактивных групп */
            font-style: italic;
        }
        .spinner-container {
            display: flex;
            align-items: center;
        }
        .spinner-grow {
            margin-right: 5px;
        }
        .missing-children {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="app" class="container mt-5">
        <h2 class="mb-4">Admin Übersicht für {{ todayDate }}</h2>

        <div v-if="loading && !recounting && !resettingFullData" class="text-center my-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
            <p>Daten werden geladen...</p>
        </div>

        <div v-if="errorMessage" class="alert alert-danger" role="alert">
            {{ errorMessage }}
        </div>
        <div v-if="successMessage" class="alert alert-success" role="alert">
            {{ successMessage }}
        </div>

        <div class="mb-4 d-flex justify-content-between align-items-center">
            <div>
                <button
                    @click="resetKinderAnzahlNow"
                    :disabled="recounting || resettingFullData"
                    class="btn btn-warning btn-lg me-2"
                >
                    <span v-if="recounting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    {{ recounting ? 'Zählvorgang läuft...' : 'Neuen Zählvorgang starten' }}
                </button>
                <button
                    @click="fullResetData"
                    :disabled="resettingFullData || recounting"
                    class="btn btn-danger btn-lg"
                >
                    <span v-if="resettingFullData" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    {{ resettingFullData ? 'Daten werden gelöscht...' : 'Aktuellen Tag zurücksetzen (Полный сброс)' }}
                </button>
            </div>
            <div class="text-end">
                <h4 class="mb-0">Gesamtzahl Kinder (Anfang): {{ totalKinderAnzahl }}</h4>
                <h4 class="mb-0" :class="{'missing-children': hasDiscrepancy}">
                    Gesamtzahl Kinder (Aktuell): {{ totalKinderAnzahlNow }}
                    <span v-if="hasDiscrepancy"> ({{ totalKinderAnzahl - totalKinderAnzahlNow }} Kind(er) fehlen!)</span>
                </h4>
            </div>
        </div>
        
        <div class="mb-4">
            <button
                @click="toggleDetails"
                class="btn btn-info"
            >
                {{ showDetails ? 'Details ausblenden' : 'Details anzeigen' }}
            </button>
        </div>

        <p v-if="!loading && !groups.length && !recounting && !resettingFullData && !showDetails" class="alert alert-info">
            Es sind noch keine Gruppeninformationen für heute verfügbar. Bitte starten Sie einen neuen Zählvorgang, um Betreuer zur Dateneingabe aufzufordern, oder zeigen Sie Details an, um eine leere Tabelle zu sehen.
        </p>

        <div v-if="showDetails && (groups.length > 0 || loading || recounting || resettingFullData)">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Gruppe Nummer</th>
                        <th>Anzahl der Kinder (Anfang)</th>
                        <th>Heute zugewiesene Betreuer</th>
                        <th>Anzahl der Kinder (Aktuell)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="group in sortedGroups" :key="group.number" :class="{'inactive-group': !group.active}">
                        <td>
                            <a :href="'group.html?gr=' + group.number">{{ group.number }}</a>
                        </td>
                        <td>
                            <template v-if="group.kinderAnzahl !== null && group.kinderAnzahl !== undefined">
                                {{ group.kinderAnzahl }}
                            </template>
                            <template v-else>
                                <div class="spinner-container">
                                    <div class="spinner-grow spinner-grow-sm text-secondary" role="status" aria-hidden="true"></div>
                                    <span>Nicht angegeben</span>
                                </div>
                            </template>
                        </td>
                        <td>
                            <ul v-if="group.betreuer && group.betreuer.length > 0" class="list-unstyled">
                                <li v-for="betreuer in group.betreuer" :key="betreuer">{{ betreuer }}</li>
                            </ul>
                            <span v-else>Nicht zugewiesen</span>
                        </td>
                        <td>
                            <template v-if="group.kinderAnzahlNow !== null && group.kinderAnzahlNow !== undefined">
                                {{ group.kinderAnzahlNow }}
                            </template>
                            <template v-else>
                                <div class="spinner-container">
                                    <div class="spinner-grow spinner-grow-sm text-secondary" role="status" aria-hidden="true"></div>
                                    <span>Berechnung läuft...</span>
                                </div>
                            </template>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <p class="mt-4" v-if="showDetails">
            <small class="text-muted">Hinweis: Gruppen in Grau haben noch keine vollständigen Informationen für heute abgegeben.</small>
        </p>
    </div>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    groups: [],
                    loading: true,
                    errorMessage: '',
                    successMessage: '',
                    todayDate: '',
                    pollingInterval: null,
                    recounting: false, // Флаг для состояния "Recount" кнопки
                    resettingFullData: false, // Флаг для состояния "Полный сброс" кнопки
                    showDetails: false, // Флаг для отображения/скрытия деталей
                    // JSONBin.io Access Information - KEEP AS IS per user instruction
                    MASTER_KEY: "$2a$10$Yxp3iL9EqLkbpNRwKv0et.hXwFYAtyN3wkFpYhkyiCmD8riOLllqm",
                    ACCESS_KEY: "$2a$10$25EbEOOZQFXGw/T2PkMKm.EELC/3G9sFCI7TNaAxpkawvjEUaAYCu", // User requested to keep 'a'
                    BIN_ID: "68834e6e7b4b8670d8a712d0"
                };
            },
            computed: {
                sortedGroups() {
                    return [...this.groups].sort((a, b) => a.number - b.number);
                },
                totalKinderAnzahl() {
                    return this.groups.reduce((sum, group) => sum + (group.kinderAnzahl || 0), 0);
                },
                totalKinderAnzahlNow() {
                    return this.groups.reduce((sum, group) => sum + (group.kinderAnzahlNow || 0), 0);
                },
                hasDiscrepancy() {
                    return this.totalKinderAnzahl !== this.totalKinderAnzahlNow;
                }
            },
            mounted() {
                this.setTodayDate();
                this.fetchAllGroupData();
                this.pollingInterval = setInterval(this.fetchAllGroupData, 10000); // 10 seconds
            },
            unmounted() {
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                }
            },
            methods: {
                setTodayDate() {
                    const today = new Date();
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    this.todayDate = today.toLocaleDateString('de-DE', options);
                },
                getTodayDateKey() {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },
                async fetchAllGroupData() {
                    this.errorMessage = ''; // Clear previous errors
                    this.successMessage = ''; // Clear success message on new fetch
                    // Показывать спиннер загрузки только если нет данных и не идет активный процесс пересчета/сброса
                    if (!this.recounting && !this.resettingFullData && (!this.groups.length || this.loading)) {
                         this.loading = true;
                    }
                   
                    const apiUrl = `https://api.jsonbin.io/v3/b/${this.BIN_ID}`;
                    const dateKey = this.getTodayDateKey();

                    try {
                        const responseGet = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'X-Master-Key': this.MASTER_KEY,
                                'X-Access-Key': this.ACCESS_KEY
                            }
                        });

                        if (!responseGet.ok) {
                            throw new Error(`Fehler beim Abrufen der Daten: ${responseGet.statusText}`);
                        }
                        let currentData = await responseGet.json();

                        if (currentData && currentData.record) {
                            currentData = currentData.record;
                        } else {
                            currentData = {};
                        }

                        const todaysGroupsData = currentData[dateKey] ? currentData[dateKey].groups : {};

                        let maxGroupNumber = 0;
                        // Determine max group number from existing data or set a default
                        for (const groupNum in todaysGroupsData) {
                            const num = parseInt(groupNum, 10);
                            if (!isNaN(num) && num > maxGroupNumber) {
                                maxGroupNumber = num;
                            }
                        }
                        // Default to 15 groups if no data or fewer groups are found, matching system structure
                        if (maxGroupNumber < 15) {
                            maxGroupNumber = 15;
                        }

                        const fetchedGroups = [];
                        for (let i = 1; i <= maxGroupNumber; i++) {
                            const groupData = todaysGroupsData[i.toString()];
                            // Группа считается активной, если есть Betreuer или KinderAnzahl
                            const isActive = !!groupData && (groupData.Betreuer && groupData.Betreuer.length > 0 || groupData.KinderAnzahl !== null); 
                            
                            fetchedGroups.push({
                                number: i,
                                kinderAnzahl: groupData && groupData.KinderAnzahl !== null ? groupData.KinderAnzahl : null,
                                betreuer: groupData && groupData.Betreuer ? groupData.Betreuer : [],
                                kinderAnzahlNow: groupData && groupData.KinderAnzahlNow !== null ? groupData.KinderAnzahlNow : null,
                                active: isActive
                            });
                        }
                        this.groups = fetchedGroups;

                    } catch (error) {
                        console.error('Fehler beim Laden der Admin Übersicht:', error);
                        this.errorMessage = `Fehler: ${error.message}`;
                        this.groups = []; // Clear groups on error
                    } finally {
                        this.loading = false;
                        this.recounting = false; // Reset recounting state after fetch
                        this.resettingFullData = false; // Reset full reset state after fetch
                    }
                },
                async resetKinderAnzahlNow() {
                    this.recounting = true;
                    this.errorMessage = '';
                    this.successMessage = '';
                    const apiUrl = `https://api.jsonbin.io/v3/b/${this.BIN_ID}`;
                    const dateKey = this.getTodayDateKey();

                    try {
                        // 1. Fetch current full data
                        const responseGet = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'X-Master-Key': this.MASTER_KEY,
                                'X-Access-Key': this.ACCESS_KEY
                            }
                        });

                        if (!responseGet.ok) {
                            throw new Error(`Fehler beim Abrufen der Daten vor Reset: ${responseGet.statusText}`);
                        }
                        let currentData = await responseGet.json();
                        let record = currentData.record || {};

                        // Ensure the structure for today's date exists
                        if (!record[dateKey]) {
                            record[dateKey] = { groups: {} };
                        }
                        // If groups object doesn't exist for today, create it
                        if (!record[dateKey].groups) {
                            record[dateKey].groups = {};
                        }

                        // 2. Modify KinderAnzahlNow to null for all groups for today
                        // Iterate through all possible groups (1 to 15)
                        for (let i = 1; i <= 15; i++) {
                            const groupNumStr = i.toString();
                            if (record[dateKey].groups[groupNumStr]) {
                                record[dateKey].groups[groupNumStr].KinderAnzahlNow = null;
                            } else {
                                // If a group doesn't exist, create a placeholder for it
                                record[dateKey].groups[groupNumStr] = {
                                    Betreuer: [],
                                    KinderAnzahl: null,
                                    KinderAnzahlNow: null
                                };
                            }
                        }

                        // 3. Send modified data back (PUT request)
                        const responsePut = await fetch(apiUrl, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Master-Key': this.MASTER_KEY,
                                'X-Access-Key': this.ACCESS_KEY
                            },
                            body: JSON.stringify(record)
                        });

                        if (!responsePut.ok) {
                            throw new Error(`Fehler beim Speichern der Daten nach Reset: ${responsePut.statusText}`);
                        }
                        await responsePut.json();
                        this.successMessage = 'Neuer Zählvorgang gestartet! Betreuer werden um Aktualisierung gebeten.';
                        this.fetchAllGroupData(); 

                    } catch (error) {
                        console.error('Fehler beim Zurücksetzen des Zählvorgangs:', error);
                        this.errorMessage = `Fehler beim Starten des Zählvorgangs: ${error.message}`;
                    } finally {
                        // recounting will be set to false by fetchAllGroupData's finally block
                    }
                },
                async fullResetData() {
                    const confirmation = confirm('Вы уверены, что хотите полностью удалить все данные за текущий день? Это действие необратимо!');
                    if (!confirmation) {
                        return;
                    }

                    this.resettingFullData = true;
                    this.errorMessage = '';
                    this.successMessage = '';
                    const apiUrl = `https://api.jsonbin.io/v3/b/${this.BIN_ID}`;
                    const dateKey = this.getTodayDateKey();

                    try {
                        // 1. Fetch current full data
                        const responseGet = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'X-Master-Key': this.MASTER_KEY,
                                'X-Access-Key': this.ACCESS_KEY
                            }
                        });

                        if (!responseGet.ok) {
                            throw new Error(`Fehler beim Abrufen der Daten vor vollständigem Reset: ${responseGet.statusText}`);
                        }
                        let currentData = await responseGet.json();
                        let record = currentData.record || {};

                        // 2. Delete the current day's data
                        if (record[dateKey]) {
                            delete record[dateKey];
                        } else {
                            this.successMessage = 'Данные за текущий день уже отсутствуют.';
                            this.fetchAllGroupData(); // Trigger a fetch to update state
                            return;
                        }

                        // 3. Send modified data back (PUT request)
                        const responsePut = await fetch(apiUrl, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Master-Key': this.MASTER_KEY,
                                'X-Access-Key': this.ACCESS_KEY
                            },
                            body: JSON.stringify(record)
                        });

                        if (!responsePut.ok) {
                            throw new Error(`Fehler beim Speichern der Daten nach vollständigem Reset: ${responsePut.statusText}`);
                        }
                        await responsePut.json();
                        this.successMessage = 'Данные за текущий день успешно удалены.';
                        this.fetchAllGroupData(); // Refresh data after deletion

                    } catch (error) {
                        console.error('Fehler beim vollständigen Zurücksetzen:', error);
                        this.errorMessage = `Fehler beim vollständigen Zurücksetzen des Tages: ${error.message}`;
                    } finally {
                        // resettingFullData will be set to false by fetchAllGroupData's finally block
                    }
                },
                toggleDetails() {
                    this.showDetails = !this.showDetails;
                }
            }
        });
        app.mount('#app');
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>