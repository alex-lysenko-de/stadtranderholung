<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Übersicht</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        .inactive-group {
            color: #6c757d; /* Серый цвет для неактивных групп */
            font-style: italic;
        }
        .spinner-container {
            display: flex;
            align-items: center;
        }
        .spinner-grow {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="app" class="container mt-5">
        <h2 class="mb-4">Admin Übersicht für {{ todayDate }}</h2>

        <div v-if="loading" class="text-center my-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
            <p>Daten werden geladen...</p>
        </div>

        <div v-if="errorMessage" class="alert alert-danger" role="alert">
            {{ errorMessage }}
        </div>

        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Gruppe Nummer</th>
                    <th>Anzahl der Kinder</th>
                    <th>Heute zugewiesene Betreuer</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="group in sortedGroups" :key="group.number" :class="{'inactive-group': !group.active}">
                    <td>
                        <a :href="'group.html?gr=' + group.number">{{ group.number }}</a>
                    </td>
                    <td>
                        <template v-if="group.kinderAnzahl !== null && group.kinderAnzahl !== undefined">
                            {{ group.kinderAnzahl }}
                        </template>
                        <template v-else>
                            <div class="spinner-container">
                                <div class="spinner-grow spinner-grow-sm text-secondary" role="status" aria-hidden="true"></div>
                                <span>Berechnung läuft...</span>
                            </div>
                        </template>
                    </td>
                    <td>
                        <ul v-if="group.betreuer && group.betreuer.length > 0" class="list-unstyled">
                            <li v-for="betreuer in group.betreuer" :key="betreuer">{{ betreuer }}</li>
                        </ul>
                        <span v-else>Nicht zugewiesen</span>
                    </td>
                </tr>
            </tbody>
        </table>

        <p class="mt-4">
            <small class="text-muted">Hinweis: Gruppen in Grau haben noch keine vollständigen Informationen für heute abgegeben.</small>
        </p>
    </div>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    groups: [],
                    loading: true,
                    errorMessage: '',
                    todayDate: '',
                    pollingInterval: null // Добавляем свойство для хранения ID интервала
                };
            },
            computed: {
                sortedGroups() {
                    return [...this.groups].sort((a, b) => a.number - b.number);
                }
            },
            mounted() {
                this.setTodayDate();
                this.fetchAllGroupData();
                // Запускаем периодический опрос каждые 10 секунд (10000 миллисекунд)
                this.pollingInterval = setInterval(this.fetchAllGroupData, 10000);
            },
            // Добавляем хук unmounted для очистки интервала, когда компонент уничтожается
            unmounted() {
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                }
            },
            methods: {
                setTodayDate() {
                    const today = new Date();
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    this.todayDate = today.toLocaleDateString('de-DE', options);
                },
                async fetchAllGroupData() {
                    // Показывать спиннер только при первой загрузке или если данные еще не были получены
                    if (!this.groups.length) {
                         this.loading = true;
                    }
                    this.errorMessage = '';
                   
                    const MASTER_KEY = "$2a$10$Yxp3iL9EqLkbpNRwKv0et.hXwFYAtyN3wkFpYhkyiCmD8riOLllqm";
                    const ACCESS_KEY = "$2a$10$25EbEOOZQFXGw/T2PkMKm.EELC/3G9sFCI7TNaAxpkawvjEUaAYCu";
                    const BIN_ID = "68834e6e7b4b8670d8a712d0"; // ID для Bin "Days" в Collection "SR2025"

                    const apiUrl = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const dateKey = `${year}-${month}-${day}`;

                    try {
                        const responseGet = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'X-Master-Key': MASTER_KEY,
                                'X-Access-Key': ACCESS_KEY
                            }
                        });

                        if (!responseGet.ok) {
                            throw new Error(`Fehler beim Abrufen der Daten: ${responseGet.statusText}`);
                        }
                        let currentData = await responseGet.json();

                        if (currentData && currentData.record) {
                            currentData = currentData.record;
                        } else {
                            currentData = {};
                        }

                        const todaysGroupsData = currentData[dateKey] ? currentData[dateKey].groups : {};

                        let maxGroupNumber = 0;
                        for (const groupNum in todaysGroupsData) {
                            const num = parseInt(groupNum, 10);
                            if (!isNaN(num) && num > maxGroupNumber) {
                                maxGroupNumber = num;
                            }
                        }

                        // Если нет данных, но хотим отобразить хотя бы одну группу (например, если группы начинаются с 1)
                        if (maxGroupNumber === 0 && Object.keys(todaysGroupsData).length === 0) {
                             maxGroupNumber = 5; // Предполагаем, что есть минимум 5 групп для отображения по умолчанию
                        }

                        const fetchedGroups = [];
                        for (let i = 1; i <= maxGroupNumber; i++) {
                            const groupData = todaysGroupsData[i.toString()];
                            const isActive = !!groupData;
                            
                            fetchedGroups.push({
                                number: i,
                                kinderAnzahl: groupData ? groupData.KinderAnzahl : null,
                                betreuer: groupData && groupData.Betreuer ? groupData.Betreuer : [],
                                active: isActive
                            });
                        }
                        this.groups = fetchedGroups; // Обновляем данные групп

                    } catch (error) {
                        console.error('Fehler beim Laden der Admin Übersicht:', error);
                        this.errorMessage = `Fehler: ${error.message}`;
                        this.groups = [];
                    } finally {
                        this.loading = false;
                    }
                }
            }
        });
        app.mount('#app');
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>