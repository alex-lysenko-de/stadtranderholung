<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruppenverwaltung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
    <div id="app" class="container mt-5">
        <h2 class="mb-4">Gruppenverwaltung</h2>

        <div class="mb-3">
            <label for="groupNumber" class="form-label">Aktuelle Gruppe:</label>
            <input type="text" class="form-control" id="groupNumber" v-model="groupNumber" readonly>
        </div>

        <form @submit.prevent="sendData">
            <div class="mb-3">
                <label for="kinderAnzahl" class="form-label">Anzahl der Kinder in der Gruppe heute:</label>
                <input type="number" min="0" class="form-control" id="kinderAnzahl" v-model="kinderAnzahl" required>
            </div>
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">Senden</button>
                <button type="button" class="btn btn-info" @click="editKinderList">Liste der Kinder bearbeiten</button>
                <button type="button" class="btn btn-secondary" @click="calculate">Rechnen</button>
            </div>
        </form>

        <div v-if="submitted" class="mt-4 p-3 bg-light border rounded">
            <h4>Übermittelte Daten:</h4>
            <p><strong>Gruppe Nummer:</strong> {{ groupNumber }}</p>
            <p><strong>Anzahl der Kinder:</strong> {{ kinderAnzahl }}</p>
            <p class="text-success" v-if="successMessage">{{ successMessage }}</p>
            <p class="text-danger" v-if="errorMessage">{{ errorMessage }}</p>
        </div>

        <div class="mt-4">
            <h4>Betreuer für diese Gruppe heute:</h4>
            <ul class="list-group">
                <li class="list-group-item" v-for="betreuer in betreuerList" :key="betreuer">{{ betreuer }}</li>
                <li class="list-group-item" v-if="betreuerList.length === 0">Keine Betreuer gefunden für diese Gruppe heute.</li>
            </ul>
        </div>
    </div>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    groupNumber: '',
                    kinderAnzahl: '',
                    submitted: false,
                    successMessage: '',
                    errorMessage: '',
                    betreuerList: []
                };
            },
            mounted() {
                // Получаем номер группы из URL-параметра 'gr'
                const urlParams = new URLSearchParams(window.location.search);
                this.groupNumber = urlParams.get('gr') || 'Nicht gefunden';

                // Загружаем список Betreuer для этой группы и текущей даты
                this.fetchBetreuerForGroup();
            },
            methods: {
                async fetchBetreuerForGroup() {
                    const MASTER_KEY = "$2a$10$Yxp3iL9EqLkbpNRwKv0et.hXwFYAtyN3wkFpYhkyiCmD8riOLllqm";
                    const ACCESS_KEY = "$2a$10$25EbEOOZQFXGw/T2PkMKm.EELC/3G9sFCI7TNaAxpkawvjEUaAYCu";
                    const BIN_ID = "68834e6e7b4b8670d8a712d0"; // ID для Bin "Days" в Collection "SR2025"

                    const apiUrl = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const dateKey = `${year}-${month}-${day}`;
                    const groupNum = this.groupNumber;

                    try {
                        const responseGet = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'X-Master-Key': MASTER_KEY,
                                'X-Access-Key': ACCESS_KEY
                            }
                        });

                        if (!responseGet.ok) {
                            throw new Error(`Fehler beim Abrufen der Daten: ${responseGet.statusText}`);
                        }
                        let currentData = await responseGet.json();

                        if (currentData && currentData.record) {
                            currentData = currentData.record;
                        } else {
                            currentData = {};
                        }

                        if (currentData[dateKey] && currentData[dateKey].groups && currentData[dateKey].groups[groupNum] && currentData[dateKey].groups[groupNum].Betreuer) {
                            this.betreuerList = currentData[dateKey].groups[groupNum].Betreuer;
                        } else {
                            this.betreuerList = [];
                        }

                    } catch (error) {
                        console.error('Fehler beim Laden der Betreuerliste:', error);
                        this.errorMessage = `Fehler beim Laden der Betreuerliste: ${error.message}`;
                        this.betreuerList = [];
                    }
                },
                async sendData() {
                    this.submitted = true;
                    this.successMessage = '';
                    this.errorMessage = '';

                    // Здесь будет логика отправки данных (например, количества детей)
                    // на сервер или в JSONBin.io.
                    // Для примера, пока просто выведем в консоль.
                    console.log('Отправка данных:', {
                        gruppeNummer: this.groupNumber,
                        kinderAnzahl: this.kinderAnzahl
                    });

                    const MASTER_KEY = "$2a$10$Yxp3iL9EqLkbpNRwKv0et.hXwFYAtyN3wkFpYhkyiCmD8riOLllqm";
                    const ACCESS_KEY = "$2a$10$25EbEOOZQFXGw/T2PkMKm.EELC/3G9sFCI7TNaAxpkawvjEUaAYCu";
                    const BIN_ID = "68834e6e7b4b8670d8a712d0"; // ID для Bin "Days" в Collection "SR2025"

                    const apiUrl = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const dateKey = `${year}-${month}-${day}`;
                    const groupNum = this.groupNumber;

                    try {
                        // 1. Получаем текущие данные из Bin
                        const responseGet = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'X-Master-Key': MASTER_KEY,
                                'X-Access-Key': ACCESS_KEY
                            }
                        });

                        if (!responseGet.ok) {
                            throw new Error(`Fehler beim Abrufen der Daten: ${responseGet.statusText}`);
                        }
                        let currentData = await responseGet.json();

                        if (currentData && currentData.record) {
                            currentData = currentData.record;
                        } else {
                            currentData = {};
                        }

                        // 2. Обновляем данные локально (добавляем количество детей)
                        if (!currentData[dateKey]) {
                            currentData[dateKey] = { groups: {} };
                        }
                        if (!currentData[dateKey].groups[groupNum]) {
                            currentData[dateKey].groups[groupNum] = { Betreuer: [], KinderAnzahl: null };
                        }
                        currentData[dateKey].groups[groupNum].KinderAnzahl = this.kinderAnzahl;

                        // 3. Отправляем обновленные данные обратно в Bin
                        const responsePut = await fetch(apiUrl, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Master-Key': MASTER_KEY,
                                'X-Access-Key': ACCESS_KEY,
                                'X-Bin-Versioning': 'false'
                            },
                            body: JSON.stringify(currentData)
                        });

                        if (!responsePut.ok) {
                            throw new Error(`Fehler beim Aktualisieren der Daten: ${responsePut.statusText}`);
                        }

                        const result = await responsePut.json();
                        console.log('Daten erfolgreich aktualisiert:', result);
                        this.successMessage = 'Daten erfolgreich gesendet!';

                    } catch (error) {
                        console.error('Fehler beim Senden der Daten an jsonbin.io:', error);
                        this.errorMessage = `Fehler: ${error.message}`;
                    }
                },
                editKinderList() {
                    // Здесь будет логика для кнопки "edit a list of kinder"
                    // Возможно, перенаправление на другую страницу или открытие модального окна
                    alert('Функция "Liste der Kinder bearbeiten" будет реализована позже.');
                },
                calculate() {
                    // Здесь будет логика для кнопки "rechnen"
                    alert('Функция "Rechnen" будет реализована позже.');
                }
            }
        });
        app.mount('#app');
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>