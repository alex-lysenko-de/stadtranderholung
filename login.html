<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anmeldeformular</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
    <div id="app" class="container mt-5">
        <h2 class="mb-4">Anmelden</h2>
        <form @submit.prevent="connectToGroup">
            <div class="mb-3">
                <label for="datumHeute" class="form-label">Datum Heute (yyyy-mm-dd):</label>
                <input type="date" class="form-control" id="datumHeute" v-model="formData.datumHeute" readonly>
            </div>
            <div class="mb-3">
                <label for="nameBetreuer" class="form-label">Name von Betreuer:</label>
                <input type="text" class="form-control" id="nameBetreuer" v-model="formData.nameBetreuer" required>
            </div>
            <div class="mb-3">
                <label for="gruppeNummer" class="form-label">Gruppe Nummer:</label>
                <input type="number" min=1  class="form-control" id="gruppeNummer" v-model="formData.gruppeNummer" required>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
        </form>

        <div v-if="submitted" class="mt-4 p-3 bg-light border rounded">
            <h4>Übermittelte Daten:</h4>
            <p><strong>Datum Heute:</strong> {{ formData.datumHeute }}</p>
            <p><strong>Name von Betreuer:</strong> {{ formData.nameBetreuer }}</p>
            <p><strong>Gruppe Nummer:</strong> {{ formData.gruppeNummer }}</p>
            <p class="text-success" v-if="successMessage">{{ successMessage }}</p>
            <p class="text-danger" v-if="errorMessage">{{ errorMessage }}</p>
        </div>
    </div>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    formData: {
                        datumHeute: '',
                        nameBetreuer: '',
                        gruppeNummer: ''
                    },
                    submitted: false,
                    successMessage: '',
                    errorMessage: ''
                };
            },
            mounted() {
                // Устанавливаем текущую дату
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                this.formData.datumHeute = `${year}-${month}-${day}`;

                // Проверяем LocalStorage на наличие betreuerName
                const savedBetreuerName = localStorage.getItem('betreuerName');
                if (savedBetreuerName) {
                    this.formData.nameBetreuer = savedBetreuerName;
                }

                // Проверяем URL на наличие GET-параметра 'gr'
                const urlParams = new URLSearchParams(window.location.search);
                const groupNumberFromUrl = urlParams.get('gr');
                if (groupNumberFromUrl) {
                    this.formData.gruppeNummer = groupNumberFromUrl;
                }
            },
            methods: {
                async connectToGroup() {
                    this.submitted = true;
                    this.successMessage = '';
                    this.errorMessage = '';

                    // Сохраняем имя betreuer в LocalStorage
                    localStorage.setItem('betreuerName', this.formData.nameBetreuer);

                    const MASTER_KEY = "$2a$10$Yxp3iL9EqLkbpNRwKv0et.hXwFYAtyN3wkFpYhkyiCmD8riOLllqm";
                    const ACCESS_KEY = "$2a$10$25EbEOOZQFXGw/T2PkMKm.EELC/3G9sFCI7TNaAxpkawvjEUaAYCu";
                    const BIN_ID = "68834e6e7b4b8670d8a712d0"; // ID для Bin "Days" в Collection "SR2025" 	

                    // Формируем URL для обновления Bin
                    const apiUrl = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

                    const dateKey = this.formData.datumHeute;
                    const groupNum = this.formData.gruppeNummer;
                    const betreuerName = this.formData.nameBetreuer;

                    try {
                        // 1. Получаем текущие данные из Bin
                        const responseGet = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'X-Master-Key': MASTER_KEY,
                                'X-Access-Key': ACCESS_KEY
                            }
                        });

                        if (!responseGet.ok) {
                            throw new Error(`Ошибка получения данных: ${responseGet.statusText}`);
                        }
                        let currentData = await responseGet.json();

                        // JSONBin.io оборачивает данные в ключ "record"
                        if (currentData && currentData.record) {
                            currentData = currentData.record;
                        } else {
                            currentData = {}; // Если данных нет или они не в ожидаемом формате, начинаем с пустого объекта
                        }

                        // 2. Обновляем данные локально
                        if (!currentData[dateKey]) {
                            currentData[dateKey] = { groups: {} };
                        }
                        if (!currentData[dateKey].groups[groupNum]) {
                            currentData[dateKey].groups[groupNum] = { Betreuer: [] };
                        }
                        if (!currentData[dateKey].groups[groupNum].Betreuer.includes(betreuerName)) {
                            currentData[dateKey].groups[groupNum].Betreuer.push(betreuerName);
                        }

                        // 3. Отправляем обновленные данные обратно в Bin
                        const responsePut = await fetch(apiUrl, {
                            method: 'PUT', // Используем PUT для полного обновления содержимого Bin
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Master-Key': MASTER_KEY,
                                'X-Access-Key': ACCESS_KEY,
                                'X-Bin-Versioning': 'false' // Отключаем версионирование, если не нужно
                            },
                            body: JSON.stringify(currentData)
                        });

                        if (!responsePut.ok) {
                            throw new Error(`Ошибка обновления данных: ${responsePut.statusText}`);
                        }

                        const result = await responsePut.json();
                        console.log('Данные успешно обновлены:', result);
                        this.successMessage = 'Данные успешно отправлены!';

                        // ************************************************************
                        // ДОБАВЛЕНО: Редирект на group.html с параметром gr
                        window.location.href = `group.html?gr=${this.formData.gruppeNummer}`;
                        // ************************************************************

                    } catch (error) {
                        console.error('Ошибка при подключении к jsonbin.io:', error);
                        this.errorMessage = `Ошибка: ${error.message}`;
                    }
                }
            }
        });
        app.mount('#app');
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>