<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Management - Stadtranderholung</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
</head>
<body>
    <div id="app">
        <div class="container py-4">
            <div id="alertContainer"></div>

            <div class="card shadow-lg">
                <div class="card-header">
                    <div class="icon">ðŸšŒ</div>
                    <h2>Bus-Management</h2>
                </div>
                <div class="card-body p-4">
                    <form @submit.prevent="saveBusData">
                        <div class="mb-3">
                            <label for="busNumber" class="form-label">Busnummer:</label>
                            <select id="busNumber" class="form-select form-control" v-model.number="formData.bus_number" @change="loadDataFromLocalStorage" :disabled="isLoading || !isConfigLoaded">
                                <option v-for="n in total_buses" :key="n" :value="n">Bus {{ n }}</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="kinderCount" class="form-label">Anzahl Kinder:</label>
                            <input type="number" id="kinderCount" class="form-control" v-model.number="formData.kinder_count" min="0" :disabled="isLoading || !isConfigLoaded">
                        </div>
                        <div class="mb-4">
                            <label for="betreuerCount" class="form-label">Anzahl Betreuer:</label>
                            <input type="number" id="betreuerCount" class="form-control" v-model.number="formData.betreuer_count" min="0" :disabled="isLoading || !isConfigLoaded">
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-bus" :disabled="isLoading || !isConfigLoaded">
                                <span v-if="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span v-else>Speichern</span>
                            </button>
                            <button type="button" class="btn btn-secondary" @click="goBack" :disabled="isLoading || !isConfigLoaded">
                                ZurÃ¼ck zur Ãœbersicht
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-center text-muted">
                    <small>Aktuelle Zeit: {{ currentDateTime }}</small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.21/vue.global.min.js"></script>
    
    <script type="module">
        import { CONFIG_DEFAULTS, JSONBinAPI, Utils } from './common.js';

        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    formData: {
                        bus_number: 1,
                        kinder_count: 0,
                        betreuer_count: 0
                    },
                    currentDateTime: '',
                    isLoading: true, // Initial loading state
                    currentDate: '', // For localStorage keying
                    isConfigLoaded: false,
                    config: {}, // Loaded config from common.js
                    api: null,  // JSONBinAPI instance
                    total_buses: CONFIG_DEFAULTS.TOTAL_BUSES // Initial fallback, updated from config
                };
            },
            
            mounted() {
                this.initializeBusPage();
            },
            
            methods: {
                /**
                 * Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ð´Ð»Ñ Vue-ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
                 * Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ API, Ð·Ð°Ñ‚ÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð°Ð²Ñ‚Ð¾Ð±ÑƒÑÐ°.
                 */
                async initializeBusPage() {
                    this.isLoading = true;
                    console.log('Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ b_bus.html...');
                    
                    const success = Utils.initializePage(this); // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸Ð· common.js

                    if (success) {
                        this.total_buses = this.config.TOTAL_BUSES; // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ total_buses Ð¸Ð· Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°
                        console.log('ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°:', this.config);
                        this.currentDate = Utils.getCurrentDateString(); // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ
                        this.loadDataFromLocalStorage(); // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· localStorage
                        await this.loadBusData(); // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
                    } else {
                        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹.');
                        Utils.showAlert('Fehler beim Laden der Konfiguration. Die Seite kann nicht richtig funktionieren.', 'danger');
                    }
                    this.updateDateTime();
                    this.startClock();
                    this.isLoading = false; // Set loading to false after all initial data is loaded
                },

                /**
                 * Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ Ð°Ð²Ñ‚Ð¾Ð±ÑƒÑÑƒ Ñ JSONBin.io.
                 */
                async loadBusData() {
                    if (!this.api || !this.isConfigLoaded) {
                        Utils.showAlert('API-Client nicht initialisiert oder Konfiguration nicht geladen.', 'danger');
                        return;
                    }

                    this.isLoading = true;
                    try {
                        const allData = await this.api.getData();
                        const dailyBusData = allData.buses && allData.buses[this.currentDate];
                        
                        if (dailyBusData) {
                            const busInfo = dailyBusData.find(bus => bus.bus_number === this.formData.bus_number);
                            if (busInfo) {
                                this.formData.kinder_count = busInfo.kinder_count;
                                this.formData.betreuer_count = busInfo.betreuer_count;
                                Utils.showAlert(`Daten fÃ¼r Bus ${this.formData.bus_number} geladen.`, 'success');
                            } else {
                                this.formData.kinder_count = 0;
                                this.formData.betreuer_count = 0;
                                Utils.showAlert(`Keine Daten fÃ¼r Bus ${this.formData.bus_number} am ${this.currentDate} gefunden.`, 'info');
                            }
                        } else {
                            this.formData.kinder_count = 0;
                            this.formData.betreuer_count = 0;
                            Utils.showAlert(`Keine Busdaten fÃ¼r ${this.currentDate} gefunden.`, 'info');
                        }
                    } catch (error) {
                        console.error('Fehler beim Laden der Busdaten:', error);
                        Utils.showAlert('Fehler beim Laden der Busdaten: ' + error.message, 'danger');
                    } finally {
                        this.isLoading = false;
                    }
                },

                /**
                 * Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ Ð°Ð²Ñ‚Ð¾Ð±ÑƒÑÑƒ Ð½Ð° JSONBin.io.
                 */
                async saveBusData() {
                    if (!this.api || !this.isConfigLoaded) {
                        Utils.showAlert('API-Client nicht initialisiert oder Konfiguration nicht geladen.', 'danger');
                        return;
                    }

                    this.isLoading = true;
                    try {
                        let allData = await this.api.getData();
                        
                        if (!allData.buses) {
                            allData.buses = {};
                        }
                        
                        if (!allData.buses[this.currentDate]) {
                            allData.buses[this.currentDate] = [];
                        }

                        // Find existing bus entry
                        let busEntryIndex = allData.buses[this.currentDate].findIndex(
                            bus => bus.bus_number === this.formData.bus_number
                        );

                        if (busEntryIndex !== -1) {
                            // Update existing entry
                            allData.buses[this.currentDate][busEntryIndex] = { ...this.formData };
                        } else {
                            // Add new entry
                            allData.buses[this.currentDate].push({ ...this.formData });
                        }

                        await this.api.updateData(allData);
                        Utils.showAlert('Busdaten erfolgreich gespeichert!', 'success');
                        this.saveDataToLocalStorage(); // Save to local storage after successful save to bin
                    } catch (error) {
                        console.error('Fehler beim Speichern der Busdaten:', error);
                        Utils.showAlert('Fehler beim Speichern der Busdaten: ' + error.message, 'danger');
                    } finally {
                        this.isLoading = false;
                    }
                },

                /**
                 * Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ Ð°Ð²Ñ‚Ð¾Ð±ÑƒÑÑƒ Ð² localStorage.
                 */
                saveDataToLocalStorage() {
                    localStorage.setItem(`last_selected_bus_number_${this.currentDate}`, this.formData.bus_number);
                    localStorage.setItem(`BusKinderCount_${this.currentDate}_${this.formData.bus_number}`, this.formData.kinder_count);
                    localStorage.setItem(`BusBetreuerCount_${this.currentDate}_${this.formData.bus_number}`, this.formData.betreuer_count);
                    console.log('Busdaten im LocalStorage gespeichert.');
                },

                /**
                 * Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ Ð°Ð²Ñ‚Ð¾Ð±ÑƒÑÑƒ Ð¸Ð· localStorage.
                 */
                loadDataFromLocalStorage() {
                    const savedBusNumber = localStorage.getItem(`last_selected_bus_number_${this.currentDate}`);
                    if (savedBusNumber) {
                        this.formData.bus_number = parseInt(savedBusNumber);
                        
                        const savedKinderCount = localStorage.getItem(`BusKinderCount_${this.currentDate}_${this.formData.bus_number}`);
                        if (savedKinderCount !== null) {
                            this.formData.kinder_count = parseInt(savedKinderCount);
                        } else {
                            this.formData.kinder_count = 0; // Reset if no data found for current bus and date
                        }
                        
                        const savedBetreuerCount = localStorage.getItem(`BusBetreuerCount_${this.currentDate}_${this.formData.bus_number}`);
                        if (savedBetreuerCount !== null) {
                            this.formData.betreuer_count = parseInt(savedBetreuerCount);
                        } else {
                            this.formData.betreuer_count = 0; // Reset if no data found for current bus and date
                        }
                        console.log('Busdaten aus LocalStorage geladen.');
                    } else {
                        console.log('Keine Busdaten im LocalStorage fÃ¼r heute gefunden. Standardwerte werden verwendet.');
                        this.formData.kinder_count = 0;
                        this.formData.betreuer_count = 0;
                    }
                    // After loading from localStorage, try to load from the bin (which might override or confirm localStorage data)
                    this.loadBusData();
                },

                /**
                 * Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°.
                 */
                goBack() {
                    Utils.navigateTo('a_login.html', this);
                },

                /**
                 * ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð´Ð°Ñ‚Ñƒ Ð¸ Ð²Ñ€ÐµÐ¼Ñ.
                 */
                updateDateTime() {
                    this.currentDateTime = Utils.getCurrentDateTime();
                },

                /**
                 * Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ñ‡Ð°ÑÑ‹ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ ÐºÐ°Ð¶Ð´ÑƒÑŽ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ.
                 */
                startClock() {
                    this.updateDateTime();
                    setInterval(() => {
                        this.updateDateTime();
                    }, 60000);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>