<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Management - Stadtranderholung</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
    <style>
        /**
 * –°—Ç–∏–ª–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–±—É—Å–æ–º (b_bus.html)
 */

/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
.container {
    padding-top: 2rem;
    padding-bottom: 2rem;
}

/* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è –∞–≤—Ç–æ–±—É—Å–∞ */
.card-header {
    background: linear-gradient(135deg, #FF6B6B 0%, #EE3364 100%);
    color: white;
    border-radius: 15px 15px 0 0;
    padding: 20px;
    text-align: center;
}

.card-header h2 {
    margin: 0;
    font-size: 1.8rem;
}

.card-header .icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

/* –°—Ç–∏–ª–∏ —Ñ–æ—Ä–º –¥–ª—è –∞–≤—Ç–æ–±—É—Å–∞ */
.form-label {
    font-weight: bold;
    color: #333;
}

.form-control {
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 10px 15px;
}

/* –ö–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ–±—É—Å–∞ */
.btn-bus {
    background-color: #EE3364;
    border-color: #EE3364;
    color: white;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 8px;
    transition: background-color 0.3s ease;
}

.btn-bus:hover {
    background-color: #d12c5b;
    border-color: #d12c5b;
}

.btn-secondary {
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: bold;
}

/* –°—Ç–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∞–≤—Ç–æ–±—É—Å–∞ */
.alert {
    display: flex;
    align-items: center;
}

.alert .spinner-border {
    margin-right: 10px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    .container {
        padding-top: 1rem;
        padding-bottom: 1rem;
    }
    
    .card {
        margin: 0 15px;
    }
    
    .card-header {
        padding: 15px;
    }
    
    .card-header h2 {
        font-size: 1.5rem;
    }
    
    .card-header .icon {
        font-size: 2rem;
    }
    
    .btn-bus, .btn-secondary {
        padding: 8px 15px;
        font-size: 0.9rem;
    }
}
    </style>
</head>
<body>
    <div id="app">
        <div class="container py-4">
            <div id="alertContainer"></div>

            <div class="card shadow-lg">
                <div class="card-header">
                    <div class="icon">üöå</div>
                    <h2>Bus-Management</h2>
                </div>
                <div class="card-body p-4">
                    <form @submit.prevent="saveBusData">
                        <div class="mb-3">
                            <label for="busNumber" class="form-label">Busnummer:</label>
                            <select id="busNumber" class="form-select form-control" v-model.number="formData.bus_number" @change="loadDataFromLocalStorage" :disabled="isLoading || !isConfigLoaded">
                                <option v-for="n in total_buses" :key="n" :value="n">Bus {{ n }}</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="kinderCount" class="form-label">Anzahl Kinder:</label>
                            <input type="number" id="kinderCount" class="form-control" v-model.number="formData.kinder_count" min="0" :disabled="isLoading || !isConfigLoaded">
                        </div>
                        <div class="mb-4">
                            <label for="betreuerCount" class="form-label">Anzahl Betreuer:</label>
                            <input type="number" id="betreuerCount" class="form-control" v-model.number="formData.betreuer_count" min="0" :disabled="isLoading || !isConfigLoaded">
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-bus" :disabled="isLoading || !isConfigLoaded">
                                <span v-if="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span v-else>Speichern</span>
                            </button>
                            <button type="button" class="btn btn-secondary" @click="goBack" :disabled="isLoading || !isConfigLoaded">
                                Zur√ºck zur √úbersicht
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-center text-muted">
                    <small>Aktuelle Zeit: {{ currentDateTime }}</small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.21/vue.global.min.js"></script>
    
    <script type="module">
        import { CONFIG_DEFAULTS, JSONBinAPI, Utils } from './common.js';

        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    formData: {
                        bus_number: 1,
                        kinder_count: 0,
                        betreuer_count: 0
                    },
                    currentDateTime: '',
                    isLoading: true, // Initial loading state
                    currentDate: '', // For localStorage keying
                    isConfigLoaded: false,
                    config: {}, // Loaded config from common.js
                    api: null,  // JSONBinAPI instance
                    total_buses: CONFIG_DEFAULTS.TOTAL_BUSES // Initial fallback, updated from config
                };
            },
            
            mounted() {
                this.initializeBusPage();
            },
            
            methods: {
                /**
                 * –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è Vue-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                 * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç API, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–±—É—Å–∞.
                 */
                async initializeBusPage() {
                    this.isLoading = true;
                    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã b_bus.html...');
                    
                    const success = Utils.initializePage(this); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ common.js

                    if (success) {
                        this.total_buses = this.config.TOTAL_BUSES; // –û–±–Ω–æ–≤–ª—è–µ–º total_buses –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
                        console.log('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', this.config);
                        this.currentDate = Utils.getCurrentDateString(); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
                        this.loadDataFromLocalStorage(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
                        await this.loadBusData(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.');
                        Utils.showAlert('Fehler beim Laden der Konfiguration. Die Seite kann nicht richtig funktionieren.', 'danger');
                    }
                    this.updateDateTime();
                    this.startClock();
                    this.isLoading = false; // Set loading to false after all initial data is loaded
                },

                /**
                 * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –∞–≤—Ç–æ–±—É—Å—É —Å JSONBin.io.
                 */
                async loadBusData() {
                    if (!this.api || !this.isConfigLoaded) {
                        Utils.showAlert('API-Client nicht initialisiert oder Konfiguration nicht geladen.', 'danger');
                        return;
                    }

                    this.isLoading = true;
                    try {
                        const allData = await this.api.getData();
                        const dailyBusData = allData.buses && allData.buses[this.currentDate];
                        
                        if (dailyBusData) {
                            const busInfo = dailyBusData.find(bus => bus.bus_number === this.formData.bus_number);
                            if (busInfo) {
                                this.formData.kinder_count = busInfo.kinder_count;
                                this.formData.betreuer_count = busInfo.betreuer_count;
                                Utils.showAlert(`Daten f√ºr Bus ${this.formData.bus_number} geladen.`, 'success');
                            } else {
                                this.formData.kinder_count = 0;
                                this.formData.betreuer_count = 0;
                                Utils.showAlert(`Keine Daten f√ºr Bus ${this.formData.bus_number} am ${this.currentDate} gefunden.`, 'info');
                            }
                        } else {
                            this.formData.kinder_count = 0;
                            this.formData.betreuer_count = 0;
                            Utils.showAlert(`Keine Busdaten f√ºr ${this.currentDate} gefunden.`, 'info');
                        }
                    } catch (error) {
                        console.error('Fehler beim Laden der Busdaten:', error);
                        Utils.showAlert('Fehler beim Laden der Busdaten: ' + error.message, 'danger');
                    } finally {
                        this.isLoading = false;
                    }
                },

                /**
                 * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –∞–≤—Ç–æ–±—É—Å—É –Ω–∞ JSONBin.io.
                 */
                async saveBusData() {
                    if (!this.api || !this.isConfigLoaded) {
                        Utils.showAlert('API-Client nicht initialisiert oder Konfiguration nicht geladen.', 'danger');
                        return;
                    }

                    this.isLoading = true;
                    try {
                        let allData = await this.api.getData();
                        
                        if (!allData.buses) {
                            allData.buses = {};
                        }
                        
                        if (!allData.buses[this.currentDate]) {
                            allData.buses[this.currentDate] = [];
                        }

                        // Find existing bus entry
                        let busEntryIndex = allData.buses[this.currentDate].findIndex(
                            bus => bus.bus_number === this.formData.bus_number
                        );

                        if (busEntryIndex !== -1) {
                            // Update existing entry
                            allData.buses[this.currentDate][busEntryIndex] = { ...this.formData };
                        } else {
                            // Add new entry
                            allData.buses[this.currentDate].push({ ...this.formData });
                        }

                        await this.api.updateData(allData);
                        Utils.showAlert('Busdaten erfolgreich gespeichert!', 'success');
                        this.saveDataToLocalStorage(); // Save to local storage after successful save to bin
                    } catch (error) {
                        console.error('Fehler beim Speichern der Busdaten:', error);
                        Utils.showAlert('Fehler beim Speichern der Busdaten: ' + error.message, 'danger');
                    } finally {
                        this.isLoading = false;
                    }
                },

                /**
                 * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∞–≤—Ç–æ–±—É—Å—É –≤ localStorage.
                 */
                saveDataToLocalStorage() {
                    localStorage.setItem(`last_selected_bus_number_${this.currentDate}`, this.formData.bus_number);
                    localStorage.setItem(`BusKinderCount_${this.currentDate}_${this.formData.bus_number}`, this.formData.kinder_count);
                    localStorage.setItem(`BusBetreuerCount_${this.currentDate}_${this.formData.bus_number}`, this.formData.betreuer_count);
                    console.log('Busdaten im LocalStorage gespeichert.');
                },

                /**
                 * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∞–≤—Ç–æ–±—É—Å—É –∏–∑ localStorage.
                 */
                loadDataFromLocalStorage() {
                    const savedBusNumber = localStorage.getItem(`last_selected_bus_number_${this.currentDate}`);
                    if (savedBusNumber) {
                        this.formData.bus_number = parseInt(savedBusNumber);
                        
                        const savedKinderCount = localStorage.getItem(`BusKinderCount_${this.currentDate}_${this.formData.bus_number}`);
                        if (savedKinderCount !== null) {
                            this.formData.kinder_count = parseInt(savedKinderCount);
                        } else {
                            this.formData.kinder_count = 0; // Reset if no data found for current bus and date
                        }
                        
                        const savedBetreuerCount = localStorage.getItem(`BusBetreuerCount_${this.currentDate}_${this.formData.bus_number}`);
                        if (savedBetreuerCount !== null) {
                            this.formData.betreuer_count = parseInt(savedBetreuerCount);
                        } else {
                            this.formData.betreuer_count = 0; // Reset if no data found for current bus and date
                        }
                        console.log('Busdaten aus LocalStorage geladen.');
                    } else {
                        console.log('Keine Busdaten im LocalStorage f√ºr heute gefunden. Standardwerte werden verwendet.');
                        this.formData.kinder_count = 0;
                        this.formData.betreuer_count = 0;
                    }
                    // After loading from localStorage, try to load from the bin (which might override or confirm localStorage data)
                    this.loadBusData();
                },

                /**
                 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
                 */
                goBack() {
                    Utils.navigateTo('a_login.html', this);
                },

                /**
                 * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.
                 */
                updateDateTime() {
                    this.currentDateTime = Utils.getCurrentDateTime();
                },

                /**
                 * –ó–∞–ø—É—Å–∫–∞–µ—Ç —á–∞—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É.
                 */
                startClock() {
                    this.updateDateTime();
                    setInterval(() => {
                        this.updateDateTime();
                    }, 60000);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>