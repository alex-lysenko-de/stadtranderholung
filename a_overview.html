<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrator-√úbersicht - Stadtranderholung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
</head>
<body>
    <div id="app">
        <div class="main-container">
            <div id="alertContainer"></div>

            <div v-if="loading" class="text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Laden...</span>
                </div>
                <p class="mt-2">Daten werden geladen...</p>
            </div>

            <div v-else-if="!isConfigLoaded" class="text-center my-5 text-danger">
                <p>Konfiguration konnte nicht geladen werden. Bitte versuchen Sie es erneut.</p>
                <button class="btn btn-primary" @click="initializeOverviewPage">Erneut versuchen</button>
            </div>

            <div v-else>
                <div class="total-summary">
                    <h2>Gesamt√ºbersicht</h2>
                    <p>Aktuelle Zeit: {{ currentDateTime }}</p>
                    <p>Anwesende Kinder (heute): <strong>{{ totalActiveChildrenToday }}</strong></p>
                    <p>Gesamtzahl Kinder (alle Gruppen): <strong>{{ totalChildrenOverall }}</strong></p>
                    <p>Gesamtzahl Betreuer (alle Gruppen): <strong>{{ totalBetreuerOverall }}</strong></p>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <div class="controls-card">
                            <h3>Z√§hlvorgang</h3>
                            <div class="d-grid gap-2">
                                <button class="btn btn-recount" @click="resetKinderAnzahlNow" :disabled="recountInitiating">
                                    <span v-if="recountInitiating" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <span v-else>Z√§hlvorgang zur√ºcksetzen</span>
                                </button>
                                <button class="btn btn-recount" @click="triggerRecount" :disabled="recountInitiating">
                                    <span v-if="recountInitiating" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <span v-else>Z√§hlvorgang starten (f√ºr alle Gruppen)</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="controls-card">
                            <h3>Navigation</h3>
                            <div class="d-grid gap-2">
                                <button class="btn btn-bus-management" @click="navigateToBusManagement">
                                    üöå Bus-Management
                                </button>
                                <button class="btn btn-back-login" @click="goBack">
                                    ‚¨ÖÔ∏è Zur√ºck zum Admin-Login
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="group-table-card">
                    <h3>Gruppen√ºbersicht ({{ formatDateForDisplay(currentDate) }})</h3>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Gruppe</th>
                                    <th>Kinder (Heute)</th>
                                    <th>Gesamt Kinder</th>
                                    <th>Betreuer</th>
                                    <th>Anwesend Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="group in groups" :key="group.groupNumber">
                                    <td>{{ group.groupNumber }}</td>
                                    <td>{{ group.KinderAnzahlNow !== null ? group.KinderAnzahlNow : 'N/A' }}</td>
                                    <td>{{ group.totalChildren }}</td>
                                    <td>{{ group.betreuerName || 'Nicht zugewiesen' }}</td>
                                    <td>
                                        <span :class="['status-dot', getStatusDotColor(group.KinderAnzahlNow, group.totalChildren)]"></span>
                                        {{ getStatusText(group.KinderAnzahlNow, group.totalChildren) }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script type="module">
        import { CONFIG_DEFAULTS, JSONBinAPI, Utils } from './common.js';

        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentDateTime: '',
                    totalActiveChildrenToday: 0,
                    totalChildrenOverall: 0,
                    totalBetreuerOverall: 0,
                    groups: [],
                    loading: true, // Initial loading state
                    recountInitiating: false, // For reset/trigger recount buttons
                    currentDate: '', // YYYY-MM-DD format for bin data keying
                    isConfigLoaded: false,
                    config: {}, // Loaded config from common.js
                    api: null,  // JSONBinAPI instance
                    total_groups: CONFIG_DEFAULTS.TOTAL_GROUPS, // Fallback, updated from config
                    total_buses: CONFIG_DEFAULTS.TOTAL_BUSES  // Fallback, updated from config
                };
            },
            
            mounted() {
                this.initializeOverviewPage();
            },
            
            methods: {
                /**
                 * –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è Vue-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                 * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç API, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ–±–∑–æ—Ä–∞.
                 */
                async initializeOverviewPage() {
                    this.loading = true;
                    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã a_overview.html...');
                    
                    const success = Utils.initializePage(this); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ common.js

                    if (success) {
                        this.total_groups = this.config.TOTAL_GROUPS;
                        this.total_buses = this.config.TOTAL_BUSES;
                        console.log('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', this.config);
                        this.currentDate = Utils.getCurrentDateString(); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
                        await this.loadOverviewData(false); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±–∑–æ—Ä–∞
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.');
                        Utils.showAlert('Fehler beim Laden der Konfiguration. Die Seite kann nicht richtig funktionieren.', 'danger');
                    }
                    this.updateDateTime();
                    this.startClock();
                    this.loading = false;
                },

                /**
                 * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ–±–∑–æ—Ä–∞ –∏–∑ JSONBin.io.
                 * @param {boolean} forceReload - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö.
                 */
                async loadOverviewData(forceReload = false) {
                    if (!this.api || !this.isConfigLoaded) {
                        Utils.showAlert('API-Client nicht initialisiert oder Konfiguration nicht geladen.', 'danger');
                        return;
                    }
                    if (!forceReload && !this.loading && this.groups.length > 0) {
                        // Avoid unnecessary reloads if data is already present and not forced
                        return;
                    }

                    this.loading = true;
                    try {
                        const allData = await this.api.getData();
                        
                        this.totalActiveChildrenToday = 0;
                        this.totalChildrenOverall = 0;
                        this.totalBetreuerOverall = 0;
                        this.groups = [];

                        // Prepare groups data
                        for (let i = 1; i <= this.total_groups; i++) {
                            const groupData = (allData.groups || []).find(g => g.groupNumber === i);
                            const dailyCounts = (allData.dailyCounts || {})[this.currentDate] || {};

                            const groupKinderAnzahlNow = dailyCounts[`group${i}_KinderAnzahlNow`];
                            const groupBetreuerName = dailyCounts[`group${i}_BetreuerName`];

                            const totalChildrenInGroup = groupData ? groupData.children.length : 0;
                            const totalBetreuerInGroup = groupData ? groupData.betreuerCount || 0 : 0;

                            this.groups.push({
                                groupNumber: i,
                                KinderAnzahlNow: groupKinderAnzahlNow !== undefined ? groupKinderAnzahlNow : null,
                                totalChildren: totalChildrenInGroup,
                                betreuerName: groupBetreuerName,
                                totalBetreuer: totalBetreuerInGroup // Assuming betreuerCount exists in groupData
                            });

                            if (groupKinderAnzahlNow !== null && groupKinderAnzahlNow !== undefined) {
                                this.totalActiveChildrenToday += groupKinderAnzahlNow;
                            }
                            this.totalChildrenOverall += totalChildrenInGroup;
                            this.totalBetreuerOverall += totalBetreuerInGroup;
                        }

                        // Also aggregate total bus data for today
                        const dailyBusData = (allData.buses || {})[this.currentDate] || [];
                        dailyBusData.forEach(bus => {
                            this.totalChildrenOverall += bus.kinder_count;
                            this.totalBetreuerOverall += bus.betreuer_count;
                        });

                        Utils.showAlert('√úbersichtsdaten erfolgreich geladen.', 'success');
                    } catch (error) {
                        console.error('Fehler beim Laden der √úbersichtsdaten:', error);
                        Utils.showAlert('Fehler beim Laden der √úbersichtsdaten: ' + error.message, 'danger');
                    } finally {
                        this.loading = false;
                    }
                },

                /**
                 * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø–æ–ª–µ KinderAnzahlNow –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–ø–ø –Ω–∞ null.
                 * –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å—á–µ—Ç—á–∏–∫ –¥–ª—è –≥—Ä—É–ø–ø –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω –∏ –æ–Ω–∏ –±—É–¥—É—Ç –∂–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞.
                 */
                async resetKinderAnzahlNow() {
                    if (!confirm('Sind Sie sicher, dass Sie den Z√§hlvorgang f√ºr alle Gruppen zur√ºcksetzen m√∂chten?')) {
                        return;
                    }

                    this.recountInitiating = true;
                    try {
                        let fullBinData = await this.api.getData();
                        if (!fullBinData.dailyCounts) {
                            fullBinData.dailyCounts = {};
                        }
                        if (!fullBinData.dailyCounts[this.currentDate]) {
                            fullBinData.dailyCounts[this.currentDate] = {};
                        }

                        // Set KinderAnzahlNow to null for all groups for the current date
                        for (let i = 1; i <= this.total_groups; i++) {
                            fullBinData.dailyCounts[this.currentDate][`group${i}_KinderAnzahlNow`] = null;
                        }

                        await this.api.updateData(fullBinData);
                        Utils.showAlert('Z√§hlvorgang f√ºr alle Gruppen zur√ºckgesetzt!', 'success');
                        await this.loadOverviewData(true); // Force reload to reflect changes
                    } catch (error) {
                        console.error('Fehler beim Zur√ºcksetzen des Z√§hlvorgangs:', error);
                        Utils.showAlert('Fehler beim Zur√ºcksetzen des Z√§hlvorgangs: ' + error.message, 'danger');
                    } finally {
                        this.recountInitiating = false;
                    }
                },

                /**
                 * –ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥—Å—á–µ—Ç–∞ KinderAnzahlNow –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–ø–ø.
                 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç KinderAnzahlNow –Ω–∞ 0 –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–ø–ø.
                 */
                async triggerRecount() {
                    if (!confirm('Sind Sie sicher, dass Sie den Z√§hlvorgang f√ºr alle Gruppen starten m√∂chten? Alle aktuellen Z√§hlungen werden auf 0 gesetzt.')) {
                        return;
                    }

                    this.recountInitiating = true;
                    try {
                        let fullBinData = await this.api.getData();
                        if (!fullBinData.dailyCounts) {
                            fullBinData.dailyCounts = {};
                        }
                        if (!fullBinData.dailyCounts[this.currentDate]) {
                            fullBinData.dailyCounts[this.currentDate] = {};
                        }

                        // Set KinderAnzahlNow to 0 for all groups for the current date
                        for (let i = 1; i <= this.total_groups; i++) {
                            fullBinData.dailyCounts[this.currentDate][`group${i}_KinderAnzahlNow`] = 0;
                        }

                        const success = await this.api.updateData(fullBinData);

                        if (success) {
                            Utils.showAlert('Z√§hlvorgang erfolgreich gestartet!', 'success');
                            // After a short delay (3 seconds) redirect to a_login.html
                            setTimeout(() => {
                                Utils.navigateTo('a_login.html', this);
                            }, 3000);
                        } else {
                            Utils.showAlert('Fehler beim Starten des Z√§hlvorgangs.', 'danger');
                        }
                    } catch (error) {
                        console.error('Fehler beim Ausl√∂sen der Z√§hlung:', error);
                        Utils.showAlert('Unerwarteter Fehler beim Starten des Z√§hlvorgangs.', 'danger');
                    } finally {
                        setTimeout(() => {
                            this.recountInitiating = false;
                            this.loadOverviewData(true); // Force reload after initiation
                        }, 2000);
                    }
                },

                /**
                 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–≤–µ—Ç —Ç–æ—á–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–µ—Ç–µ–π.
                 * @param {number|null} kinderNow - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π, –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–µ–≥–æ–¥–Ω—è.
                 * @param {number} totalChildren - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π –≤ –≥—Ä—É–ø–ø–µ.
                 * @returns {string} –ö–ª–∞—Å—Å —Ü–≤–µ—Ç–∞ ('green', 'red', 'orange', 'gray').
                 */
                getStatusDotColor(kinderNow, totalChildren) {
                    if (kinderNow === null || kinderNow === undefined) {
                        return 'gray'; // Not counted yet
                    } else if (kinderNow > 0 && kinderNow < totalChildren) {
                        return 'orange'; // Partially present
                    } else if (kinderNow === totalChildren && totalChildren > 0) {
                        return 'green'; // All present
                    } else if (kinderNow === 0 && totalChildren === 0) {
                        return 'gray'; // Empty group, N/A status
                    } else { // kinderNow is 0 but totalChildren > 0
                        return 'red'; // No children present
                    }
                },

                /**
                 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≥—Ä—É–ø–ø—ã.
                 * @param {number|null} kinderNow - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π, –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–µ–≥–æ–¥–Ω—è.
                 * @param {number} totalChildren - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π –≤ –≥—Ä—É–ø–ø–µ.
                 * @returns {string} –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞.
                 */
                getStatusText(kinderNow, totalChildren) {
                    if (kinderNow === null || kinderNow === undefined) {
                        return 'Noch nicht gez√§hlt';
                    } else if (kinderNow > 0 && kinderNow < totalChildren) {
                        return 'Teilweise anwesend';
                    } else if (kinderNow === totalChildren && totalChildren > 0) {
                        return 'Alle anwesend';
                    } else if (kinderNow === 0 && totalChildren === 0) {
                        return 'Keine Kinder zugewiesen';
                    } else { // kinderNow is 0 but totalChildren > 0
                        return 'Keine anwesend';
                    }
                },

                /**
                 * –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–±—É—Å–∞–º–∏.
                 */
                navigateToBusManagement() {
                    Utils.navigateTo('b_bus.html', this);
                },

                /**
                 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–æ–≥–æ –ª–æ–≥–∏–Ω–∞.
                 */
                goBack() {
                    Utils.navigateTo('a_login.html', this);
                },

                /**
                 * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.
                 */
                updateDateTime() {
                    this.currentDateTime = Utils.getCurrentDateTime();
                },

                /**
                 * –ó–∞–ø—É—Å–∫–∞–µ—Ç —á–∞—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É.
                 */
                startClock() {
                    this.updateDateTime();
                    setInterval(() => {
                        this.updateDateTime();
                    }, 60000);
                },

                /**
                 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
                 * @param {string} dateString - –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD.
                 * @returns {string} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–∞—Ç—ã.
                 */
                formatDateForDisplay(dateString) {
                    return Utils.formatDateForDisplay(dateString);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>